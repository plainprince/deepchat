// The module 'vscode' contains the VS Code extensibility API

const { default: ollama } = require('ollama');
// const { showCompletion, typeInCompletion, hideCompletion } = require('./completions.js');

// Import the module and reference it with the alias vscode in your code below
const vscode = require('vscode');

// This method is called when your extension is activated
// Your extension is activated the very first time the command is executed

/**
 * @param {vscode.ExtensionContext} context
 */
function activate(context) {

	// Use the console to output diagnostic information (console.log) and errors (console.error)
	// This line of code will only be executed once when your extension is activated
	console.log('DeepChat activated...');

	let model = {name: 'deepseek-r1:8b'}

	// The command has been defined in the package.json file
	// Now provide the implementation of the command with  registerCommand
	// The commandId parameter must match the command field in package.json
	let disposable = vscode.commands.registerCommand('deepchat.openChat', function () {
		const panel = vscode.window.createWebviewPanel(
			'deepchat',
			'DeepChat',
			vscode.ViewColumn.Two,
			{ enableScripts: true }
		)

		panel.webview.html = /*html*/`
            <!DOCTYPE html>
			<html lang="en">
			<head>
				<meta charset="UTF-8">
				<meta http-equiv="X-UA-Compatible" content="IE=edge">
				<meta name="viewport" content="width=device-width, initial-scale=1.0">
				<title>DeepChat</title>
				<style>
					#response {
						display: grid;
						grid-template-rows: repeat(auto-fit, minmax(1.5em, auto));
						transition: grid-template-rows 0.3s ease-out;
					}

					.think {
						max-width: 70vw;    /* Set your desired maximum width */
						white-space: nowrap;  /* Prevents text from wrapping to a new line */
						overflow: hidden;     /* Hides any content that overflows */
						text-overflow: ellipsis; /* Adds the ellipsis (...) when text is truncated */
						color: gray;
					}

					.think p {
						margin: 0;
						padding: 0;
						display: inline-block; /* Makes paragraphs appear in a single line */
					}

					.think:hover {
						max-height: none; /* Expand fully */
						white-space: normal;
						max-width: 100%;
					}

					.think:hover p {
						white-space: normal;
					}

					hr {
						display: block;
						width: 100%;
						margin: 20px 0; /* Reset default margin */
					}

					
.chat-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    align-items: center;
    padding: 10px;
    background: white;
    border-top: 1px solid #ddd;
    gap: 10px;
	background-color: inherit;
}

#chat {
    flex: 1;
    max-height: 1.5rem;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    resize: none;
    overflow-y: auto;
    font-size: 16px;
	max-width: 75%;
}

#send {
    background: #007aff;
    color: white;
    border: none;
    padding: 10px 15px;
	right: 0;
    border-radius: 8px;
    font-size: 18px;
    cursor: pointer;
    transition: background 0.2s ease-in-out;
}

#send:hover {
    background: #005ecb;
}

#send:active {
    background: #004a9f;
}

@media (max-width: 500px) {
    .chat-container {
        padding: 8px;
    }

    #chat {
        font-size: 14px;
    }

    #send {
        font-size: 16px;
        padding: 8px 12px;
    }
}

body {
	margin-bottom: 2rem;
}
				</style>
			</head>
			<body>
				<h1>DeepChat</h1>
				<div id="response"></div><br>

				<div class="chat-container">
					<textarea id="chat" cols="30" rows="10"></textarea><br>
					<button id="send">Send</button>
				</div>

				<script src="data:text/javascript;base64,LyoqCiAqIG1hcmtlZCB2MTUuMC42IC0gYSBtYXJrZG93biBwYXJzZXIKICogQ29weXJpZ2h0IChjKSAyMDExLTIwMjUsIENocmlzdG9waGVyIEplZmZyZXkuIChNSVQgTGljZW5zZWQpCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJrZWRqcy9tYXJrZWQKICovCiFmdW5jdGlvbihlLHQpeyJvYmplY3QiPT10eXBlb2YgZXhwb3J0cyYmInVuZGVmaW5lZCIhPXR5cGVvZiBtb2R1bGU/dChleHBvcnRzKToiZnVuY3Rpb24iPT10eXBlb2YgZGVmaW5lJiZkZWZpbmUuYW1kP2RlZmluZShbImV4cG9ydHMiXSx0KTp0KChlPSJ1bmRlZmluZWQiIT10eXBlb2YgZ2xvYmFsVGhpcz9nbG9iYWxUaGlzOmV8fHNlbGYpLm1hcmtlZD17fSl9KHRoaXMsKGZ1bmN0aW9uKGUpeyJ1c2Ugc3RyaWN0IjtmdW5jdGlvbiB0KCl7cmV0dXJue2FzeW5jOiExLGJyZWFrczohMSxleHRlbnNpb25zOm51bGwsZ2ZtOiEwLGhvb2tzOm51bGwscGVkYW50aWM6ITEscmVuZGVyZXI6bnVsbCxzaWxlbnQ6ITEsdG9rZW5pemVyOm51bGwsd2Fsa1Rva2VuczpudWxsfX1mdW5jdGlvbiBuKHQpe2UuZGVmYXVsdHM9dH1lLmRlZmF1bHRzPXthc3luYzohMSxicmVha3M6ITEsZXh0ZW5zaW9uczpudWxsLGdmbTohMCxob29rczpudWxsLHBlZGFudGljOiExLHJlbmRlcmVyOm51bGwsc2lsZW50OiExLHRva2VuaXplcjpudWxsLHdhbGtUb2tlbnM6bnVsbH07Y29uc3Qgcz17ZXhlYzooKT0+bnVsbH07ZnVuY3Rpb24gcihlLHQ9IiIpe2xldCBuPSJzdHJpbmciPT10eXBlb2YgZT9lOmUuc291cmNlO2NvbnN0IHM9e3JlcGxhY2U6KGUsdCk9PntsZXQgcj0ic3RyaW5nIj09dHlwZW9mIHQ/dDp0LnNvdXJjZTtyZXR1cm4gcj1yLnJlcGxhY2UoaS5jYXJldCwiJDEiKSxuPW4ucmVwbGFjZShlLHIpLHN9LGdldFJlZ2V4OigpPT5uZXcgUmVnRXhwKG4sdCl9O3JldHVybiBzfWNvbnN0IGk9e2NvZGVSZW1vdmVJbmRlbnQ6L14oPzogezEsNH18IHswLDN9XHQpL2dtLG91dHB1dExpbmtSZXBsYWNlOi9cXChbXFtcXV0pL2csaW5kZW50Q29kZUNvbXBlbnNhdGlvbjovXihccyspKD86YGBgKS8sYmVnaW5uaW5nU3BhY2U6L15ccysvLGVuZGluZ0hhc2g6LyMkLyxzdGFydGluZ1NwYWNlQ2hhcjovXiAvLGVuZGluZ1NwYWNlQ2hhcjovICQvLG5vblNwYWNlQ2hhcjovW14gXS8sbmV3TGluZUNoYXJHbG9iYWw6L1xuL2csdGFiQ2hhckdsb2JhbDovXHQvZyxtdWx0aXBsZVNwYWNlR2xvYmFsOi9ccysvZyxibGFua0xpbmU6L15bIFx0XSokLyxkb3VibGVCbGFua0xpbmU6L1xuWyBcdF0qXG5bIFx0XSokLyxibG9ja3F1b3RlU3RhcnQ6L14gezAsM30+LyxibG9ja3F1b3RlU2V0ZXh0UmVwbGFjZTovXG4gezAsM30oKD86PSt8LSspICopKD89XG58JCkvZyxibG9ja3F1b3RlU2V0ZXh0UmVwbGFjZTI6L14gezAsM30+WyBcdF0/L2dtLGxpc3RSZXBsYWNlVGFiczovXlx0Ky8sbGlzdFJlcGxhY2VOZXN0aW5nOi9eIHsxLDR9KD89KCB7NH0pKlteIF0pL2csbGlzdElzVGFzazovXlxbWyB4WF1cXSAvLGxpc3RSZXBsYWNlVGFzazovXlxbWyB4WF1cXSArLyxhbnlMaW5lOi9cbi4qXG4vLGhyZWZCcmFja2V0czovXjwoLiopPiQvLHRhYmxlRGVsaW1pdGVyOi9bOnxdLyx0YWJsZUFsaWduQ2hhcnM6L15cfHxcfCAqJC9nLHRhYmxlUm93QmxhbmtMaW5lOi9cblsgXHRdKiQvLHRhYmxlQWxpZ25SaWdodDovXiAqLSs6ICokLyx0YWJsZUFsaWduQ2VudGVyOi9eICo6LSs6ICokLyx0YWJsZUFsaWduTGVmdDovXiAqOi0rICokLyxzdGFydEFUYWc6L148YSAvaSxlbmRBVGFnOi9ePFwvYT4vaSxzdGFydFByZVNjcmlwdFRhZzovXjwocHJlfGNvZGV8a2JkfHNjcmlwdCkoXHN8PikvaSxlbmRQcmVTY3JpcHRUYWc6L148XC8ocHJlfGNvZGV8a2JkfHNjcmlwdCkoXHN8PikvaSxzdGFydEFuZ2xlQnJhY2tldDovXjwvLGVuZEFuZ2xlQnJhY2tldDovPiQvLHBlZGFudGljSHJlZlRpdGxlOi9eKFteJyJdKlteXHNdKVxzKyhbJyJdKSguKilcMi8sdW5pY29kZUFscGhhTnVtZXJpYzovW1xwe0x9XHB7Tn1dL3UsZXNjYXBlVGVzdDovWyY8PiInXS8sZXNjYXBlUmVwbGFjZTovWyY8PiInXS9nLGVzY2FwZVRlc3ROb0VuY29kZTovWzw+IiddfCYoPyEoI1xkezEsN318I1tYeF1bYS1mQS1GMC05XXsxLDZ9fFx3Kyk7KS8sZXNjYXBlUmVwbGFjZU5vRW5jb2RlOi9bPD4iJ118Jig/ISgjXGR7MSw3fXwjW1h4XVthLWZBLUYwLTldezEsNn18XHcrKTspL2csdW5lc2NhcGVUZXN0Oi8mKCMoPzpcZCspfCg/OiN4WzAtOUEtRmEtZl0rKXwoPzpcdyspKTs/L2dpLGNhcmV0Oi8oXnxbXlxbXSlcXi9nLHBlcmNlbnREZWNvZGU6LyUyNS9nLGZpbmRQaXBlOi9cfC9nLHNwbGl0UGlwZTovIFx8LyxzbGFzaFBpcGU6L1xcXHwvZyxjYXJyaWFnZVJldHVybjovXHJcbnxcci9nLHNwYWNlTGluZTovXiArJC9nbSxub3RTcGFjZVN0YXJ0Oi9eXFMqLyxlbmRpbmdOZXdsaW5lOi9cbiQvLGxpc3RJdGVtUmVnZXg6ZT0+bmV3IFJlZ0V4cChgXiggezAsM30ke2V9KSgoPzpbXHQgXVteXFxuXSopPyg/OlxcbnwkKSlgKSxuZXh0QnVsbGV0UmVnZXg6ZT0+bmV3IFJlZ0V4cChgXiB7MCwke01hdGgubWluKDMsZS0xKX19KD86WyorLV18XFxkezEsOX1bLildKSgoPzpbIFx0XVteXFxuXSopPyg/OlxcbnwkKSlgKSxoclJlZ2V4OmU9Pm5ldyBSZWdFeHAoYF4gezAsJHtNYXRoLm1pbigzLGUtMSl9fSgoPzotICopezMsfXwoPzpfICopezMsfXwoPzpcXCogKil7Myx9KSg/Olxcbit8JClgKSxmZW5jZXNCZWdpblJlZ2V4OmU9Pm5ldyBSZWdFeHAoYF4gezAsJHtNYXRoLm1pbigzLGUtMSl9fSg/OlxgXGBcYHx+fn4pYCksaGVhZGluZ0JlZ2luUmVnZXg6ZT0+bmV3IFJlZ0V4cChgXiB7MCwke01hdGgubWluKDMsZS0xKX19I2ApLGh0bWxCZWdpblJlZ2V4OmU9Pm5ldyBSZWdFeHAoYF4gezAsJHtNYXRoLm1pbigzLGUtMSl9fTwoPzpbYS16XS4qPnwhLS0pYCwiaSIpfSxsPS9eIHswLDN9KCg/Oi1bXHQgXSopezMsfXwoPzpfWyBcdF0qKXszLH18KD86XCpbIFx0XSopezMsfSkoPzpcbit8JCkvLG89Lyg/OlsqKy1dfFxkezEsOX1bLildKS8sYT1yKC9eKD8hYnVsbCB8YmxvY2tDb2RlfGZlbmNlc3xibG9ja3F1b3RlfGhlYWRpbmd8aHRtbCkoKD86Lnxcbig/IVxzKj9cbnxidWxsIHxibG9ja0NvZGV8ZmVuY2VzfGJsb2NrcXVvdGV8aGVhZGluZ3xodG1sKSkrPylcbiB7MCwzfSg9K3wtKykgKig/OlxuK3wkKS8pLnJlcGxhY2UoL2J1bGwvZyxvKS5yZXBsYWNlKC9ibG9ja0NvZGUvZywvKD86IHs0fXwgezAsM31cdCkvKS5yZXBsYWNlKC9mZW5jZXMvZywvIHswLDN9KD86YHszLH18fnszLH0pLykucmVwbGFjZSgvYmxvY2txdW90ZS9nLC8gezAsM30+LykucmVwbGFjZSgvaGVhZGluZy9nLC8gezAsM30jezEsNn0vKS5yZXBsYWNlKC9odG1sL2csLyB7MCwzfTxbXlxuPl0rPlxuLykuZ2V0UmVnZXgoKSxjPS9eKFteXG5dKyg/OlxuKD8haHJ8aGVhZGluZ3xsaGVhZGluZ3xibG9ja3F1b3RlfGZlbmNlc3xsaXN0fGh0bWx8dGFibGV8ICtcbilbXlxuXSspKikvLGg9Lyg/IVxzKlxdKSg/OlxcLnxbXlxbXF1cXF0pKy8scD1yKC9eIHswLDN9XFsobGFiZWwpXF06ICooPzpcblsgXHRdKik/KFtePFxzXVteXHNdKnw8Lio/PikoPzooPzogKyg/OlxuWyBcdF0qKT98ICpcblsgXHRdKikodGl0bGUpKT8gKig/OlxuK3wkKS8pLnJlcGxhY2UoImxhYmVsIixoKS5yZXBsYWNlKCJ0aXRsZSIsLyg/OiIoPzpcXCI/fFteIlxcXSkqInwnW14nXG5dKig/OlxuW14nXG5dKykqXG4/J3xcKFteKCldKlwpKS8pLmdldFJlZ2V4KCksdT1yKC9eKCB7MCwzfWJ1bGwpKFsgXHRdW15cbl0rPyk/KD86XG58JCkvKS5yZXBsYWNlKC9idWxsL2csbykuZ2V0UmVnZXgoKSxnPSJhZGRyZXNzfGFydGljbGV8YXNpZGV8YmFzZXxiYXNlZm9udHxibG9ja3F1b3RlfGJvZHl8Y2FwdGlvbnxjZW50ZXJ8Y29sfGNvbGdyb3VwfGRkfGRldGFpbHN8ZGlhbG9nfGRpcnxkaXZ8ZGx8ZHR8ZmllbGRzZXR8ZmlnY2FwdGlvbnxmaWd1cmV8Zm9vdGVyfGZvcm18ZnJhbWV8ZnJhbWVzZXR8aFsxLTZdfGhlYWR8aGVhZGVyfGhyfGh0bWx8aWZyYW1lfGxlZ2VuZHxsaXxsaW5rfG1haW58bWVudXxtZW51aXRlbXxtZXRhfG5hdnxub2ZyYW1lc3xvbHxvcHRncm91cHxvcHRpb258cHxwYXJhbXxzZWFyY2h8c2VjdGlvbnxzdW1tYXJ5fHRhYmxlfHRib2R5fHRkfHRmb290fHRofHRoZWFkfHRpdGxlfHRyfHRyYWNrfHVsIixrPS88IS0tKD86LT8+fFtcc1xTXSo/KD86LS0+fCQpKS8sZD1yKCJeIHswLDN9KD86PChzY3JpcHR8cHJlfHN0eWxlfHRleHRhcmVhKVtcXHM+XVtcXHNcXFNdKj8oPzo8L1xcMT5bXlxcbl0qXFxuK3wkKXxjb21tZW50W15cXG5dKihcXG4rfCQpfDxcXD9bXFxzXFxTXSo/KD86XFw/Plxcbip8JCl8PCFbQS1aXVtcXHNcXFNdKj8oPzo+XFxuKnwkKXw8IVxcW0NEQVRBXFxbW1xcc1xcU10qPyg/OlxcXVxcXT5cXG4qfCQpfDwvPyh0YWcpKD86ICt8XFxufC8/PilbXFxzXFxTXSo/KD86KD86XFxuWyBcdF0qKStcXG58JCl8PCg/IXNjcmlwdHxwcmV8c3R5bGV8dGV4dGFyZWEpKFthLXpdW1xcdy1dKikoPzphdHRyaWJ1dGUpKj8gKi8/Pig/PVsgXFx0XSooPzpcXG58JCkpW1xcc1xcU10qPyg/Oig/OlxcblsgXHRdKikrXFxufCQpfDwvKD8hc2NyaXB0fHByZXxzdHlsZXx0ZXh0YXJlYSlbYS16XVtcXHctXSpcXHMqPig/PVsgXFx0XSooPzpcXG58JCkpW1xcc1xcU10qPyg/Oig/OlxcblsgXHRdKikrXFxufCQpKSIsImkiKS5yZXBsYWNlKCJjb21tZW50IixrKS5yZXBsYWNlKCJ0YWciLGcpLnJlcGxhY2UoImF0dHJpYnV0ZSIsLyArW2EtekEtWjpfXVtcdy46LV0qKD86ICo9ICoiW14iXG5dKiJ8ICo9IConW14nXG5dKid8ICo9ICpbXlxzIic9PD5gXSspPy8pLmdldFJlZ2V4KCksZj1yKGMpLnJlcGxhY2UoImhyIixsKS5yZXBsYWNlKCJoZWFkaW5nIiwiIHswLDN9I3sxLDZ9KD86XFxzfCQpIikucmVwbGFjZSgifGxoZWFkaW5nIiwiIikucmVwbGFjZSgifHRhYmxlIiwiIikucmVwbGFjZSgiYmxvY2txdW90ZSIsIiB7MCwzfT4iKS5yZXBsYWNlKCJmZW5jZXMiLCIgezAsM30oPzpgezMsfSg/PVteYFxcbl0qXFxuKXx+ezMsfSlbXlxcbl0qXFxuIikucmVwbGFjZSgibGlzdCIsIiB7MCwzfSg/OlsqKy1dfDFbLildKSAiKS5yZXBsYWNlKCJodG1sIiwiPC8/KD86dGFnKSg/OiArfFxcbnwvPz4pfDwoPzpzY3JpcHR8cHJlfHN0eWxlfHRleHRhcmVhfCEtLSkiKS5yZXBsYWNlKCJ0YWciLGcpLmdldFJlZ2V4KCkseD17YmxvY2txdW90ZTpyKC9eKCB7MCwzfT4gPyhwYXJhZ3JhcGh8W15cbl0qKSg/OlxufCQpKSsvKS5yZXBsYWNlKCJwYXJhZ3JhcGgiLGYpLmdldFJlZ2V4KCksY29kZTovXigoPzogezR9fCB7MCwzfVx0KVteXG5dKyg/OlxuKD86WyBcdF0qKD86XG58JCkpKik/KSsvLGRlZjpwLGZlbmNlczovXiB7MCwzfShgezMsfSg/PVteYFxuXSooPzpcbnwkKSl8fnszLH0pKFteXG5dKikoPzpcbnwkKSg/OnwoW1xzXFNdKj8pKD86XG58JCkpKD86IHswLDN9XDFbfmBdKiAqKD89XG58JCl8JCkvLGhlYWRpbmc6L14gezAsM30oI3sxLDZ9KSg/PVxzfCQpKC4qKSg/OlxuK3wkKS8saHI6bCxodG1sOmQsbGhlYWRpbmc6YSxsaXN0OnUsbmV3bGluZTovXig/OlsgXHRdKig/OlxufCQpKSsvLHBhcmFncmFwaDpmLHRhYmxlOnMsdGV4dDovXlteXG5dKy99LGI9cigiXiAqKFteXFxuIF0uKilcXG4gezAsM30oKD86XFx8ICopPzo/LSs6PyAqKD86XFx8ICo6Py0rOj8gKikqKD86XFx8ICopPykoPzpcXG4oKD86KD8hICpcXG58aHJ8aGVhZGluZ3xibG9ja3F1b3RlfGNvZGV8ZmVuY2VzfGxpc3R8aHRtbCkuKig/OlxcbnwkKSkqKVxcbip8JCkiKS5yZXBsYWNlKCJociIsbCkucmVwbGFjZSgiaGVhZGluZyIsIiB7MCwzfSN7MSw2fSg/Olxcc3wkKSIpLnJlcGxhY2UoImJsb2NrcXVvdGUiLCIgezAsM30+IikucmVwbGFjZSgiY29kZSIsIig/OiB7NH18IHswLDN9XHQpW15cXG5dIikucmVwbGFjZSgiZmVuY2VzIiwiIHswLDN9KD86YHszLH0oPz1bXmBcXG5dKlxcbil8fnszLH0pW15cXG5dKlxcbiIpLnJlcGxhY2UoImxpc3QiLCIgezAsM30oPzpbKistXXwxWy4pXSkgIikucmVwbGFjZSgiaHRtbCIsIjwvPyg/OnRhZykoPzogK3xcXG58Lz8+KXw8KD86c2NyaXB0fHByZXxzdHlsZXx0ZXh0YXJlYXwhLS0pIikucmVwbGFjZSgidGFnIixnKS5nZXRSZWdleCgpLHc9ey4uLngsdGFibGU6YixwYXJhZ3JhcGg6cihjKS5yZXBsYWNlKCJociIsbCkucmVwbGFjZSgiaGVhZGluZyIsIiB7MCwzfSN7MSw2fSg/Olxcc3wkKSIpLnJlcGxhY2UoInxsaGVhZGluZyIsIiIpLnJlcGxhY2UoInRhYmxlIixiKS5yZXBsYWNlKCJibG9ja3F1b3RlIiwiIHswLDN9PiIpLnJlcGxhY2UoImZlbmNlcyIsIiB7MCwzfSg/OmB7Myx9KD89W15gXFxuXSpcXG4pfH57Myx9KVteXFxuXSpcXG4iKS5yZXBsYWNlKCJsaXN0IiwiIHswLDN9KD86WyorLV18MVsuKV0pICIpLnJlcGxhY2UoImh0bWwiLCI8Lz8oPzp0YWcpKD86ICt8XFxufC8/Pil8PCg/OnNjcmlwdHxwcmV8c3R5bGV8dGV4dGFyZWF8IS0tKSIpLnJlcGxhY2UoInRhZyIsZykuZ2V0UmVnZXgoKX0sbT17Li4ueCxodG1sOnIoIl4gKig/OmNvbW1lbnQgKig/OlxcbnxcXHMqJCl8PCh0YWcpW1xcc1xcU10rPzwvXFwxPiAqKD86XFxuezIsfXxcXHMqJCl8PHRhZyg/OlwiW15cIl0qXCJ8J1teJ10qJ3xcXHNbXidcIi8+XFxzXSopKj8vPz4gKig/OlxcbnsyLH18XFxzKiQpKSIpLnJlcGxhY2UoImNvbW1lbnQiLGspLnJlcGxhY2UoL3RhZy9nLCIoPyEoPzphfGVtfHN0cm9uZ3xzbWFsbHxzfGNpdGV8cXxkZm58YWJicnxkYXRhfHRpbWV8Y29kZXx2YXJ8c2FtcHxrYmR8c3VifHN1cHxpfGJ8dXxtYXJrfHJ1Ynl8cnR8cnB8YmRpfGJkb3xzcGFufGJyfHdicnxpbnN8ZGVsfGltZylcXGIpXFx3Kyg/ITp8W15cXHdcXHNAXSpAKVxcYiIpLmdldFJlZ2V4KCksZGVmOi9eICpcWyhbXlxdXSspXF06ICo8PyhbXlxzPl0rKT4/KD86ICsoWyIoXVteXG5dK1siKV0pKT8gKig/OlxuK3wkKS8saGVhZGluZzovXigjezEsNn0pKC4qKSg/OlxuK3wkKS8sZmVuY2VzOnMsbGhlYWRpbmc6L14oLis/KVxuIHswLDN9KD0rfC0rKSAqKD86XG4rfCQpLyxwYXJhZ3JhcGg6cihjKS5yZXBsYWNlKCJociIsbCkucmVwbGFjZSgiaGVhZGluZyIsIiAqI3sxLDZ9ICpbXlxuXSIpLnJlcGxhY2UoImxoZWFkaW5nIixhKS5yZXBsYWNlKCJ8dGFibGUiLCIiKS5yZXBsYWNlKCJibG9ja3F1b3RlIiwiIHswLDN9PiIpLnJlcGxhY2UoInxmZW5jZXMiLCIiKS5yZXBsYWNlKCJ8bGlzdCIsIiIpLnJlcGxhY2UoInxodG1sIiwiIikucmVwbGFjZSgifHRhZyIsIiIpLmdldFJlZ2V4KCl9LHk9L14oIHsyLH18XFwpXG4oPyFccyokKS8sJD0vW1xwe1B9XHB7U31dL3UsUj0vW1xzXHB7UH1ccHtTfV0vdSxTPS9bXlxzXHB7UH1ccHtTfV0vdSxUPXIoL14oKD8hWypfXSlwdW5jdFNwYWNlKS8sInUiKS5yZXBsYWNlKC9wdW5jdFNwYWNlL2csUikuZ2V0UmVnZXgoKSx6PS8oPyF+KVtccHtQfVxwe1N9XS91LEE9L14oPzpcKisoPzooKD8hXCopcHVuY3QpfFteXHMqXSkpfF5fKyg/OigoPyFfKXB1bmN0KXwoW15cc19dKSkvLF89cihBLCJ1IikucmVwbGFjZSgvcHVuY3QvZywkKS5nZXRSZWdleCgpLFA9cihBLCJ1IikucmVwbGFjZSgvcHVuY3QvZyx6KS5nZXRSZWdleCgpLEk9Il5bXl8qXSo/X19bXl8qXSo/XFwqW15fKl0qPyg/PV9fKXxbXipdKyg/PVteKl0pfCg/IVxcKilwdW5jdChcXCorKSg/PVtcXHNdfCQpfG5vdFB1bmN0U3BhY2UoXFwqKykoPyFcXCopKD89cHVuY3RTcGFjZXwkKXwoPyFcXCopcHVuY3RTcGFjZShcXCorKSg/PW5vdFB1bmN0U3BhY2UpfFtcXHNdKFxcKispKD8hXFwqKSg/PXB1bmN0KXwoPyFcXCopcHVuY3QoXFwqKykoPyFcXCopKD89cHVuY3QpfG5vdFB1bmN0U3BhY2UoXFwqKykoPz1ub3RQdW5jdFNwYWNlKSIsTD1yKEksImd1IikucmVwbGFjZSgvbm90UHVuY3RTcGFjZS9nLFMpLnJlcGxhY2UoL3B1bmN0U3BhY2UvZyxSKS5yZXBsYWNlKC9wdW5jdC9nLCQpLmdldFJlZ2V4KCksQj1yKEksImd1IikucmVwbGFjZSgvbm90UHVuY3RTcGFjZS9nLC8oPzpbXlxzXHB7UH1ccHtTfV18fikvdSkucmVwbGFjZSgvcHVuY3RTcGFjZS9nLC8oPyF+KVtcc1xwe1B9XHB7U31dL3UpLnJlcGxhY2UoL3B1bmN0L2cseikuZ2V0UmVnZXgoKSxDPXIoIl5bXl8qXSo/XFwqXFwqW15fKl0qP19bXl8qXSo/KD89XFwqXFwqKXxbXl9dKyg/PVteX10pfCg/IV8pcHVuY3QoXyspKD89W1xcc118JCl8bm90UHVuY3RTcGFjZShfKykoPyFfKSg/PXB1bmN0U3BhY2V8JCl8KD8hXylwdW5jdFNwYWNlKF8rKSg/PW5vdFB1bmN0U3BhY2UpfFtcXHNdKF8rKSg/IV8pKD89cHVuY3QpfCg/IV8pcHVuY3QoXyspKD8hXykoPz1wdW5jdCkiLCJndSIpLnJlcGxhY2UoL25vdFB1bmN0U3BhY2UvZyxTKS5yZXBsYWNlKC9wdW5jdFNwYWNlL2csUikucmVwbGFjZSgvcHVuY3QvZywkKS5nZXRSZWdleCgpLEU9cigvXFwocHVuY3QpLywiZ3UiKS5yZXBsYWNlKC9wdW5jdC9nLCQpLmdldFJlZ2V4KCkscT1yKC9ePChzY2hlbWU6W15cc1x4MDAtXHgxZjw+XSp8ZW1haWwpPi8pLnJlcGxhY2UoInNjaGVtZSIsL1thLXpBLVpdW2EtekEtWjAtOSsuLV17MSwzMX0vKS5yZXBsYWNlKCJlbWFpbCIsL1thLXpBLVowLTkuISMkJSYnKisvPT9eX2B7fH1+LV0rKEApW2EtekEtWjAtOV0oPzpbYS16QS1aMC05LV17MCw2MX1bYS16QS1aMC05XSk/KD86XC5bYS16QS1aMC05XSg/OlthLXpBLVowLTktXXswLDYxfVthLXpBLVowLTldKT8pKyg/IVstX10pLykuZ2V0UmVnZXgoKSxaPXIoaykucmVwbGFjZSgiKD86LS1ceDNlfCQpIiwiLS1ceDNlIikuZ2V0UmVnZXgoKSx2PXIoIl5jb21tZW50fF48L1thLXpBLVpdW1xcdzotXSpcXHMqPnxePFthLXpBLVpdW1xcdy1dKig/OmF0dHJpYnV0ZSkqP1xccyovPz58XjxcXD9bXFxzXFxTXSo/XFw/PnxePCFbYS16QS1aXStcXHNbXFxzXFxTXSo/PnxePCFcXFtDREFUQVxcW1tcXHNcXFNdKj9cXF1cXF0+IikucmVwbGFjZSgiY29tbWVudCIsWikucmVwbGFjZSgiYXR0cmlidXRlIiwvXHMrW2EtekEtWjpfXVtcdy46LV0qKD86XHMqPVxzKiJbXiJdKiJ8XHMqPVxzKidbXiddKid8XHMqPVxzKlteXHMiJz08PmBdKyk/LykuZ2V0UmVnZXgoKSxEPS8oPzpcWyg/OlxcLnxbXlxbXF1cXF0pKlxdfFxcLnxgW15gXSpgfFteXFtcXVxcYF0pKj8vLE09cigvXiE/XFsobGFiZWwpXF1cKFxzKihocmVmKSg/OlxzKyh0aXRsZSkpP1xzKlwpLykucmVwbGFjZSgibGFiZWwiLEQpLnJlcGxhY2UoImhyZWYiLC88KD86XFwufFteXG48PlxcXSkrPnxbXlxzXHgwMC1ceDFmXSovKS5yZXBsYWNlKCJ0aXRsZSIsLyIoPzpcXCI/fFteIlxcXSkqInwnKD86XFwnP3xbXidcXF0pKid8XCgoPzpcXFwpP3xbXilcXF0pKlwpLykuZ2V0UmVnZXgoKSxPPXIoL14hP1xbKGxhYmVsKVxdXFsocmVmKVxdLykucmVwbGFjZSgibGFiZWwiLEQpLnJlcGxhY2UoInJlZiIsaCkuZ2V0UmVnZXgoKSxRPXIoL14hP1xbKHJlZilcXSg/OlxbXF0pPy8pLnJlcGxhY2UoInJlZiIsaCkuZ2V0UmVnZXgoKSxqPXtfYmFja3BlZGFsOnMsYW55UHVuY3R1YXRpb246RSxhdXRvbGluazpxLGJsb2NrU2tpcDovXFtbXltcXV0qP1xdXCgoPzpcXC58W15cXFwoXCldfFwoKD86XFwufFteXFxcKFwpXSkqXCkpKlwpfGBbXmBdKj9gfDxbXjw+XSo/Pi9nLGJyOnksY29kZTovXihgKykoW15gXXxbXmBdW1xzXFNdKj9bXmBdKVwxKD8hYCkvLGRlbDpzLGVtU3Ryb25nTERlbGltOl8sZW1TdHJvbmdSRGVsaW1Bc3Q6TCxlbVN0cm9uZ1JEZWxpbVVuZDpDLGVzY2FwZTovXlxcKFshIiMkJSYnKCkqKyxcLS4vOjs8PT4/QFxbXF1cXF5fYHt8fX5dKS8sbGluazpNLG5vbGluazpRLHB1bmN0dWF0aW9uOlQscmVmbGluazpPLHJlZmxpbmtTZWFyY2g6cigicmVmbGlua3xub2xpbmsoPyFcXCgpIiwiZyIpLnJlcGxhY2UoInJlZmxpbmsiLE8pLnJlcGxhY2UoIm5vbGluayIsUSkuZ2V0UmVnZXgoKSx0YWc6dix0ZXh0Oi9eKGArfFteYF0pKD86KD89IHsyLH1cbil8W1xzXFNdKj8oPzooPz1bXFw8IVxbYCpfXXxcYl98JCl8W14gXSg/PSB7Mix9XG4pKSkvLHVybDpzfSxOPXsuLi5qLGxpbms6cigvXiE/XFsobGFiZWwpXF1cKCguKj8pXCkvKS5yZXBsYWNlKCJsYWJlbCIsRCkuZ2V0UmVnZXgoKSxyZWZsaW5rOnIoL14hP1xbKGxhYmVsKVxdXHMqXFsoW15cXV0qKVxdLykucmVwbGFjZSgibGFiZWwiLEQpLmdldFJlZ2V4KCl9LEc9ey4uLmosZW1TdHJvbmdSRGVsaW1Bc3Q6QixlbVN0cm9uZ0xEZWxpbTpQLHVybDpyKC9eKCg/OmZ0cHxodHRwcz8pOlwvXC98d3d3XC4pKD86W2EtekEtWjAtOVwtXStcLj8pK1teXHM8XSp8XmVtYWlsLywiaSIpLnJlcGxhY2UoImVtYWlsIiwvW0EtWmEtejAtOS5fKy1dKyhAKVthLXpBLVowLTktX10rKD86XC5bYS16QS1aMC05LV9dKlthLXpBLVowLTldKSsoPyFbLV9dKS8pLmdldFJlZ2V4KCksX2JhY2twZWRhbDovKD86W14/IS4sOjsqXycifigpJl0rfFwoW14pXSpcKXwmKD8hW2EtekEtWjAtOV0rOyQpfFs/IS4sOjsqXycifildKyg/ISQpKSsvLGRlbDovXih+fj8pKD89W15cc35dKSgoPzpcXC58W15cXF0pKj8oPzpcXC58W15cc35cXF0pKVwxKD89W15+XXwkKS8sdGV4dDovXihbYH5dK3xbXmB+XSkoPzooPz0gezIsfVxuKXwoPz1bYS16QS1aMC05LiEjJCUmJyorXC89P19ge1x8fX4tXStAKXxbXHNcU10qPyg/Oig/PVtcXDwhXFtgKn5fXXxcYl98aHR0cHM/OlwvXC98ZnRwOlwvXC98d3d3XC58JCl8W14gXSg/PSB7Mix9XG4pfFteYS16QS1aMC05LiEjJCUmJyorXC89P19ge1x8fX4tXSg/PVthLXpBLVowLTkuISMkJSYnKitcLz0/X2B7XHx9fi1dK0ApKSkvfSxIPXsuLi5HLGJyOnIoeSkucmVwbGFjZSgiezIsfSIsIioiKS5nZXRSZWdleCgpLHRleHQ6cihHLnRleHQpLnJlcGxhY2UoIlxcYl8iLCJcXGJffCB7Mix9XFxuIikucmVwbGFjZSgvXHsyLFx9L2csIioiKS5nZXRSZWdleCgpfSxYPXtub3JtYWw6eCxnZm06dyxwZWRhbnRpYzptfSxGPXtub3JtYWw6aixnZm06RyxicmVha3M6SCxwZWRhbnRpYzpOfSxVPXsiJiI6IiZhbXA7IiwiPCI6IiZsdDsiLCI+IjoiJmd0OyIsJyInOiImcXVvdDsiLCInIjoiJiMzOTsifSxKPWU9PlVbZV07ZnVuY3Rpb24gSyhlLHQpe2lmKHQpe2lmKGkuZXNjYXBlVGVzdC50ZXN0KGUpKXJldHVybiBlLnJlcGxhY2UoaS5lc2NhcGVSZXBsYWNlLEopfWVsc2UgaWYoaS5lc2NhcGVUZXN0Tm9FbmNvZGUudGVzdChlKSlyZXR1cm4gZS5yZXBsYWNlKGkuZXNjYXBlUmVwbGFjZU5vRW5jb2RlLEopO3JldHVybiBlfWZ1bmN0aW9uIFYoZSl7dHJ5e2U9ZW5jb2RlVVJJKGUpLnJlcGxhY2UoaS5wZXJjZW50RGVjb2RlLCIlIil9Y2F0Y2h7cmV0dXJuIG51bGx9cmV0dXJuIGV9ZnVuY3Rpb24gVyhlLHQpe2NvbnN0IG49ZS5yZXBsYWNlKGkuZmluZFBpcGUsKChlLHQsbik9PntsZXQgcz0hMSxyPXQ7Zm9yKDstLXI+PTAmJiJcXCI9PT1uW3JdOylzPSFzO3JldHVybiBzPyJ8IjoiIHwifSkpLnNwbGl0KGkuc3BsaXRQaXBlKTtsZXQgcz0wO2lmKG5bMF0udHJpbSgpfHxuLnNoaWZ0KCksbi5sZW5ndGg+MCYmIW4uYXQoLTEpPy50cmltKCkmJm4ucG9wKCksdClpZihuLmxlbmd0aD50KW4uc3BsaWNlKHQpO2Vsc2UgZm9yKDtuLmxlbmd0aDx0OyluLnB1c2goIiIpO2Zvcig7czxuLmxlbmd0aDtzKyspbltzXT1uW3NdLnRyaW0oKS5yZXBsYWNlKGkuc2xhc2hQaXBlLCJ8Iik7cmV0dXJuIG59ZnVuY3Rpb24gWShlLHQsbil7Y29uc3Qgcz1lLmxlbmd0aDtpZigwPT09cylyZXR1cm4iIjtsZXQgcj0wO2Zvcig7cjxzOyl7aWYoZS5jaGFyQXQocy1yLTEpIT09dClicmVhaztyKyt9cmV0dXJuIGUuc2xpY2UoMCxzLXIpfWZ1bmN0aW9uIGVlKGUsdCxuLHMscil7Y29uc3QgaT10LmhyZWYsbD10LnRpdGxlfHxudWxsLG89ZVsxXS5yZXBsYWNlKHIub3RoZXIub3V0cHV0TGlua1JlcGxhY2UsIiQxIik7aWYoIiEiIT09ZVswXS5jaGFyQXQoMCkpe3Muc3RhdGUuaW5MaW5rPSEwO2NvbnN0IGU9e3R5cGU6ImxpbmsiLHJhdzpuLGhyZWY6aSx0aXRsZTpsLHRleHQ6byx0b2tlbnM6cy5pbmxpbmVUb2tlbnMobyl9O3JldHVybiBzLnN0YXRlLmluTGluaz0hMSxlfXJldHVybnt0eXBlOiJpbWFnZSIscmF3Om4saHJlZjppLHRpdGxlOmwsdGV4dDpvfX1jbGFzcyB0ZXtvcHRpb25zO3J1bGVzO2xleGVyO2NvbnN0cnVjdG9yKHQpe3RoaXMub3B0aW9ucz10fHxlLmRlZmF1bHRzfXNwYWNlKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5ibG9jay5uZXdsaW5lLmV4ZWMoZSk7aWYodCYmdFswXS5sZW5ndGg+MClyZXR1cm57dHlwZToic3BhY2UiLHJhdzp0WzBdfX1jb2RlKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5ibG9jay5jb2RlLmV4ZWMoZSk7aWYodCl7Y29uc3QgZT10WzBdLnJlcGxhY2UodGhpcy5ydWxlcy5vdGhlci5jb2RlUmVtb3ZlSW5kZW50LCIiKTtyZXR1cm57dHlwZToiY29kZSIscmF3OnRbMF0sY29kZUJsb2NrU3R5bGU6ImluZGVudGVkIix0ZXh0OnRoaXMub3B0aW9ucy5wZWRhbnRpYz9lOlkoZSwiXG4iKX19fWZlbmNlcyhlKXtjb25zdCB0PXRoaXMucnVsZXMuYmxvY2suZmVuY2VzLmV4ZWMoZSk7aWYodCl7Y29uc3QgZT10WzBdLG49ZnVuY3Rpb24oZSx0LG4pe2NvbnN0IHM9ZS5tYXRjaChuLm90aGVyLmluZGVudENvZGVDb21wZW5zYXRpb24pO2lmKG51bGw9PT1zKXJldHVybiB0O2NvbnN0IHI9c1sxXTtyZXR1cm4gdC5zcGxpdCgiXG4iKS5tYXAoKGU9Pntjb25zdCB0PWUubWF0Y2gobi5vdGhlci5iZWdpbm5pbmdTcGFjZSk7aWYobnVsbD09PXQpcmV0dXJuIGU7Y29uc3Rbc109dDtyZXR1cm4gcy5sZW5ndGg+PXIubGVuZ3RoP2Uuc2xpY2Uoci5sZW5ndGgpOmV9KSkuam9pbigiXG4iKX0oZSx0WzNdfHwiIix0aGlzLnJ1bGVzKTtyZXR1cm57dHlwZToiY29kZSIscmF3OmUsbGFuZzp0WzJdP3RbMl0udHJpbSgpLnJlcGxhY2UodGhpcy5ydWxlcy5pbmxpbmUuYW55UHVuY3R1YXRpb24sIiQxIik6dFsyXSx0ZXh0Om59fX1oZWFkaW5nKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5ibG9jay5oZWFkaW5nLmV4ZWMoZSk7aWYodCl7bGV0IGU9dFsyXS50cmltKCk7aWYodGhpcy5ydWxlcy5vdGhlci5lbmRpbmdIYXNoLnRlc3QoZSkpe2NvbnN0IHQ9WShlLCIjIik7dGhpcy5vcHRpb25zLnBlZGFudGljP2U9dC50cmltKCk6dCYmIXRoaXMucnVsZXMub3RoZXIuZW5kaW5nU3BhY2VDaGFyLnRlc3QodCl8fChlPXQudHJpbSgpKX1yZXR1cm57dHlwZToiaGVhZGluZyIscmF3OnRbMF0sZGVwdGg6dFsxXS5sZW5ndGgsdGV4dDplLHRva2Vuczp0aGlzLmxleGVyLmlubGluZShlKX19fWhyKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5ibG9jay5oci5leGVjKGUpO2lmKHQpcmV0dXJue3R5cGU6ImhyIixyYXc6WSh0WzBdLCJcbiIpfX1ibG9ja3F1b3RlKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5ibG9jay5ibG9ja3F1b3RlLmV4ZWMoZSk7aWYodCl7bGV0IGU9WSh0WzBdLCJcbiIpLnNwbGl0KCJcbiIpLG49IiIscz0iIjtjb25zdCByPVtdO2Zvcig7ZS5sZW5ndGg+MDspe2xldCB0PSExO2NvbnN0IGk9W107bGV0IGw7Zm9yKGw9MDtsPGUubGVuZ3RoO2wrKylpZih0aGlzLnJ1bGVzLm90aGVyLmJsb2NrcXVvdGVTdGFydC50ZXN0KGVbbF0pKWkucHVzaChlW2xdKSx0PSEwO2Vsc2V7aWYodClicmVhaztpLnB1c2goZVtsXSl9ZT1lLnNsaWNlKGwpO2NvbnN0IG89aS5qb2luKCJcbiIpLGE9by5yZXBsYWNlKHRoaXMucnVsZXMub3RoZXIuYmxvY2txdW90ZVNldGV4dFJlcGxhY2UsIlxuICAgICQxIikucmVwbGFjZSh0aGlzLnJ1bGVzLm90aGVyLmJsb2NrcXVvdGVTZXRleHRSZXBsYWNlMiwiIik7bj1uP2Ake259XG4ke299YDpvLHM9cz9gJHtzfVxuJHthfWA6YTtjb25zdCBjPXRoaXMubGV4ZXIuc3RhdGUudG9wO2lmKHRoaXMubGV4ZXIuc3RhdGUudG9wPSEwLHRoaXMubGV4ZXIuYmxvY2tUb2tlbnMoYSxyLCEwKSx0aGlzLmxleGVyLnN0YXRlLnRvcD1jLDA9PT1lLmxlbmd0aClicmVhaztjb25zdCBoPXIuYXQoLTEpO2lmKCJjb2RlIj09PWg/LnR5cGUpYnJlYWs7aWYoImJsb2NrcXVvdGUiPT09aD8udHlwZSl7Y29uc3QgdD1oLGk9dC5yYXcrIlxuIitlLmpvaW4oIlxuIiksbD10aGlzLmJsb2NrcXVvdGUoaSk7cltyLmxlbmd0aC0xXT1sLG49bi5zdWJzdHJpbmcoMCxuLmxlbmd0aC10LnJhdy5sZW5ndGgpK2wucmF3LHM9cy5zdWJzdHJpbmcoMCxzLmxlbmd0aC10LnRleHQubGVuZ3RoKStsLnRleHQ7YnJlYWt9aWYoImxpc3QiIT09aD8udHlwZSk7ZWxzZXtjb25zdCB0PWgsaT10LnJhdysiXG4iK2Uuam9pbigiXG4iKSxsPXRoaXMubGlzdChpKTtyW3IubGVuZ3RoLTFdPWwsbj1uLnN1YnN0cmluZygwLG4ubGVuZ3RoLWgucmF3Lmxlbmd0aCkrbC5yYXcscz1zLnN1YnN0cmluZygwLHMubGVuZ3RoLXQucmF3Lmxlbmd0aCkrbC5yYXcsZT1pLnN1YnN0cmluZyhyLmF0KC0xKS5yYXcubGVuZ3RoKS5zcGxpdCgiXG4iKX19cmV0dXJue3R5cGU6ImJsb2NrcXVvdGUiLHJhdzpuLHRva2VuczpyLHRleHQ6c319fWxpc3QoZSl7bGV0IHQ9dGhpcy5ydWxlcy5ibG9jay5saXN0LmV4ZWMoZSk7aWYodCl7bGV0IG49dFsxXS50cmltKCk7Y29uc3Qgcz1uLmxlbmd0aD4xLHI9e3R5cGU6Imxpc3QiLHJhdzoiIixvcmRlcmVkOnMsc3RhcnQ6cz8rbi5zbGljZSgwLC0xKToiIixsb29zZTohMSxpdGVtczpbXX07bj1zP2BcXGR7MSw5fVxcJHtuLnNsaWNlKC0xKX1gOmBcXCR7bn1gLHRoaXMub3B0aW9ucy5wZWRhbnRpYyYmKG49cz9uOiJbKistXSIpO2NvbnN0IGk9dGhpcy5ydWxlcy5vdGhlci5saXN0SXRlbVJlZ2V4KG4pO2xldCBsPSExO2Zvcig7ZTspe2xldCBuPSExLHM9IiIsbz0iIjtpZighKHQ9aS5leGVjKGUpKSlicmVhaztpZih0aGlzLnJ1bGVzLmJsb2NrLmhyLnRlc3QoZSkpYnJlYWs7cz10WzBdLGU9ZS5zdWJzdHJpbmcocy5sZW5ndGgpO2xldCBhPXRbMl0uc3BsaXQoIlxuIiwxKVswXS5yZXBsYWNlKHRoaXMucnVsZXMub3RoZXIubGlzdFJlcGxhY2VUYWJzLChlPT4iICIucmVwZWF0KDMqZS5sZW5ndGgpKSksYz1lLnNwbGl0KCJcbiIsMSlbMF0saD0hYS50cmltKCkscD0wO2lmKHRoaXMub3B0aW9ucy5wZWRhbnRpYz8ocD0yLG89YS50cmltU3RhcnQoKSk6aD9wPXRbMV0ubGVuZ3RoKzE6KHA9dFsyXS5zZWFyY2godGhpcy5ydWxlcy5vdGhlci5ub25TcGFjZUNoYXIpLHA9cD40PzE6cCxvPWEuc2xpY2UocCkscCs9dFsxXS5sZW5ndGgpLGgmJnRoaXMucnVsZXMub3RoZXIuYmxhbmtMaW5lLnRlc3QoYykmJihzKz1jKyJcbiIsZT1lLnN1YnN0cmluZyhjLmxlbmd0aCsxKSxuPSEwKSwhbil7Y29uc3QgdD10aGlzLnJ1bGVzLm90aGVyLm5leHRCdWxsZXRSZWdleChwKSxuPXRoaXMucnVsZXMub3RoZXIuaHJSZWdleChwKSxyPXRoaXMucnVsZXMub3RoZXIuZmVuY2VzQmVnaW5SZWdleChwKSxpPXRoaXMucnVsZXMub3RoZXIuaGVhZGluZ0JlZ2luUmVnZXgocCksbD10aGlzLnJ1bGVzLm90aGVyLmh0bWxCZWdpblJlZ2V4KHApO2Zvcig7ZTspe2NvbnN0IHU9ZS5zcGxpdCgiXG4iLDEpWzBdO2xldCBnO2lmKGM9dSx0aGlzLm9wdGlvbnMucGVkYW50aWM/KGM9Yy5yZXBsYWNlKHRoaXMucnVsZXMub3RoZXIubGlzdFJlcGxhY2VOZXN0aW5nLCIgICIpLGc9Yyk6Zz1jLnJlcGxhY2UodGhpcy5ydWxlcy5vdGhlci50YWJDaGFyR2xvYmFsLCIgICAgIiksci50ZXN0KGMpKWJyZWFrO2lmKGkudGVzdChjKSlicmVhaztpZihsLnRlc3QoYykpYnJlYWs7aWYodC50ZXN0KGMpKWJyZWFrO2lmKG4udGVzdChjKSlicmVhaztpZihnLnNlYXJjaCh0aGlzLnJ1bGVzLm90aGVyLm5vblNwYWNlQ2hhcik+PXB8fCFjLnRyaW0oKSlvKz0iXG4iK2cuc2xpY2UocCk7ZWxzZXtpZihoKWJyZWFrO2lmKGEucmVwbGFjZSh0aGlzLnJ1bGVzLm90aGVyLnRhYkNoYXJHbG9iYWwsIiAgICAiKS5zZWFyY2godGhpcy5ydWxlcy5vdGhlci5ub25TcGFjZUNoYXIpPj00KWJyZWFrO2lmKHIudGVzdChhKSlicmVhaztpZihpLnRlc3QoYSkpYnJlYWs7aWYobi50ZXN0KGEpKWJyZWFrO28rPSJcbiIrY31ofHxjLnRyaW0oKXx8KGg9ITApLHMrPXUrIlxuIixlPWUuc3Vic3RyaW5nKHUubGVuZ3RoKzEpLGE9Zy5zbGljZShwKX19ci5sb29zZXx8KGw/ci5sb29zZT0hMDp0aGlzLnJ1bGVzLm90aGVyLmRvdWJsZUJsYW5rTGluZS50ZXN0KHMpJiYobD0hMCkpO2xldCB1LGc9bnVsbDt0aGlzLm9wdGlvbnMuZ2ZtJiYoZz10aGlzLnJ1bGVzLm90aGVyLmxpc3RJc1Rhc2suZXhlYyhvKSxnJiYodT0iWyBdICIhPT1nWzBdLG89by5yZXBsYWNlKHRoaXMucnVsZXMub3RoZXIubGlzdFJlcGxhY2VUYXNrLCIiKSkpLHIuaXRlbXMucHVzaCh7dHlwZToibGlzdF9pdGVtIixyYXc6cyx0YXNrOiEhZyxjaGVja2VkOnUsbG9vc2U6ITEsdGV4dDpvLHRva2VuczpbXX0pLHIucmF3Kz1zfWNvbnN0IG89ci5pdGVtcy5hdCgtMSk7aWYoIW8pcmV0dXJuO28ucmF3PW8ucmF3LnRyaW1FbmQoKSxvLnRleHQ9by50ZXh0LnRyaW1FbmQoKSxyLnJhdz1yLnJhdy50cmltRW5kKCk7Zm9yKGxldCBlPTA7ZTxyLml0ZW1zLmxlbmd0aDtlKyspaWYodGhpcy5sZXhlci5zdGF0ZS50b3A9ITEsci5pdGVtc1tlXS50b2tlbnM9dGhpcy5sZXhlci5ibG9ja1Rva2VucyhyLml0ZW1zW2VdLnRleHQsW10pLCFyLmxvb3NlKXtjb25zdCB0PXIuaXRlbXNbZV0udG9rZW5zLmZpbHRlcigoZT0+InNwYWNlIj09PWUudHlwZSkpLG49dC5sZW5ndGg+MCYmdC5zb21lKChlPT50aGlzLnJ1bGVzLm90aGVyLmFueUxpbmUudGVzdChlLnJhdykpKTtyLmxvb3NlPW59aWYoci5sb29zZSlmb3IobGV0IGU9MDtlPHIuaXRlbXMubGVuZ3RoO2UrKylyLml0ZW1zW2VdLmxvb3NlPSEwO3JldHVybiByfX1odG1sKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5ibG9jay5odG1sLmV4ZWMoZSk7aWYodCl7cmV0dXJue3R5cGU6Imh0bWwiLGJsb2NrOiEwLHJhdzp0WzBdLHByZToicHJlIj09PXRbMV18fCJzY3JpcHQiPT09dFsxXXx8InN0eWxlIj09PXRbMV0sdGV4dDp0WzBdfX19ZGVmKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5ibG9jay5kZWYuZXhlYyhlKTtpZih0KXtjb25zdCBlPXRbMV0udG9Mb3dlckNhc2UoKS5yZXBsYWNlKHRoaXMucnVsZXMub3RoZXIubXVsdGlwbGVTcGFjZUdsb2JhbCwiICIpLG49dFsyXT90WzJdLnJlcGxhY2UodGhpcy5ydWxlcy5vdGhlci5ocmVmQnJhY2tldHMsIiQxIikucmVwbGFjZSh0aGlzLnJ1bGVzLmlubGluZS5hbnlQdW5jdHVhdGlvbiwiJDEiKToiIixzPXRbM10/dFszXS5zdWJzdHJpbmcoMSx0WzNdLmxlbmd0aC0xKS5yZXBsYWNlKHRoaXMucnVsZXMuaW5saW5lLmFueVB1bmN0dWF0aW9uLCIkMSIpOnRbM107cmV0dXJue3R5cGU6ImRlZiIsdGFnOmUscmF3OnRbMF0saHJlZjpuLHRpdGxlOnN9fX10YWJsZShlKXtjb25zdCB0PXRoaXMucnVsZXMuYmxvY2sudGFibGUuZXhlYyhlKTtpZighdClyZXR1cm47aWYoIXRoaXMucnVsZXMub3RoZXIudGFibGVEZWxpbWl0ZXIudGVzdCh0WzJdKSlyZXR1cm47Y29uc3Qgbj1XKHRbMV0pLHM9dFsyXS5yZXBsYWNlKHRoaXMucnVsZXMub3RoZXIudGFibGVBbGlnbkNoYXJzLCIiKS5zcGxpdCgifCIpLHI9dFszXT8udHJpbSgpP3RbM10ucmVwbGFjZSh0aGlzLnJ1bGVzLm90aGVyLnRhYmxlUm93QmxhbmtMaW5lLCIiKS5zcGxpdCgiXG4iKTpbXSxpPXt0eXBlOiJ0YWJsZSIscmF3OnRbMF0saGVhZGVyOltdLGFsaWduOltdLHJvd3M6W119O2lmKG4ubGVuZ3RoPT09cy5sZW5ndGgpe2Zvcihjb25zdCBlIG9mIHMpdGhpcy5ydWxlcy5vdGhlci50YWJsZUFsaWduUmlnaHQudGVzdChlKT9pLmFsaWduLnB1c2goInJpZ2h0Iik6dGhpcy5ydWxlcy5vdGhlci50YWJsZUFsaWduQ2VudGVyLnRlc3QoZSk/aS5hbGlnbi5wdXNoKCJjZW50ZXIiKTp0aGlzLnJ1bGVzLm90aGVyLnRhYmxlQWxpZ25MZWZ0LnRlc3QoZSk/aS5hbGlnbi5wdXNoKCJsZWZ0Iik6aS5hbGlnbi5wdXNoKG51bGwpO2ZvcihsZXQgZT0wO2U8bi5sZW5ndGg7ZSsrKWkuaGVhZGVyLnB1c2goe3RleHQ6bltlXSx0b2tlbnM6dGhpcy5sZXhlci5pbmxpbmUobltlXSksaGVhZGVyOiEwLGFsaWduOmkuYWxpZ25bZV19KTtmb3IoY29uc3QgZSBvZiByKWkucm93cy5wdXNoKFcoZSxpLmhlYWRlci5sZW5ndGgpLm1hcCgoKGUsdCk9Pih7dGV4dDplLHRva2Vuczp0aGlzLmxleGVyLmlubGluZShlKSxoZWFkZXI6ITEsYWxpZ246aS5hbGlnblt0XX0pKSkpO3JldHVybiBpfX1saGVhZGluZyhlKXtjb25zdCB0PXRoaXMucnVsZXMuYmxvY2subGhlYWRpbmcuZXhlYyhlKTtpZih0KXJldHVybnt0eXBlOiJoZWFkaW5nIixyYXc6dFswXSxkZXB0aDoiPSI9PT10WzJdLmNoYXJBdCgwKT8xOjIsdGV4dDp0WzFdLHRva2Vuczp0aGlzLmxleGVyLmlubGluZSh0WzFdKX19cGFyYWdyYXBoKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5ibG9jay5wYXJhZ3JhcGguZXhlYyhlKTtpZih0KXtjb25zdCBlPSJcbiI9PT10WzFdLmNoYXJBdCh0WzFdLmxlbmd0aC0xKT90WzFdLnNsaWNlKDAsLTEpOnRbMV07cmV0dXJue3R5cGU6InBhcmFncmFwaCIscmF3OnRbMF0sdGV4dDplLHRva2Vuczp0aGlzLmxleGVyLmlubGluZShlKX19fXRleHQoZSl7Y29uc3QgdD10aGlzLnJ1bGVzLmJsb2NrLnRleHQuZXhlYyhlKTtpZih0KXJldHVybnt0eXBlOiJ0ZXh0IixyYXc6dFswXSx0ZXh0OnRbMF0sdG9rZW5zOnRoaXMubGV4ZXIuaW5saW5lKHRbMF0pfX1lc2NhcGUoZSl7Y29uc3QgdD10aGlzLnJ1bGVzLmlubGluZS5lc2NhcGUuZXhlYyhlKTtpZih0KXJldHVybnt0eXBlOiJlc2NhcGUiLHJhdzp0WzBdLHRleHQ6dFsxXX19dGFnKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5pbmxpbmUudGFnLmV4ZWMoZSk7aWYodClyZXR1cm4hdGhpcy5sZXhlci5zdGF0ZS5pbkxpbmsmJnRoaXMucnVsZXMub3RoZXIuc3RhcnRBVGFnLnRlc3QodFswXSk/dGhpcy5sZXhlci5zdGF0ZS5pbkxpbms9ITA6dGhpcy5sZXhlci5zdGF0ZS5pbkxpbmsmJnRoaXMucnVsZXMub3RoZXIuZW5kQVRhZy50ZXN0KHRbMF0pJiYodGhpcy5sZXhlci5zdGF0ZS5pbkxpbms9ITEpLCF0aGlzLmxleGVyLnN0YXRlLmluUmF3QmxvY2smJnRoaXMucnVsZXMub3RoZXIuc3RhcnRQcmVTY3JpcHRUYWcudGVzdCh0WzBdKT90aGlzLmxleGVyLnN0YXRlLmluUmF3QmxvY2s9ITA6dGhpcy5sZXhlci5zdGF0ZS5pblJhd0Jsb2NrJiZ0aGlzLnJ1bGVzLm90aGVyLmVuZFByZVNjcmlwdFRhZy50ZXN0KHRbMF0pJiYodGhpcy5sZXhlci5zdGF0ZS5pblJhd0Jsb2NrPSExKSx7dHlwZToiaHRtbCIscmF3OnRbMF0saW5MaW5rOnRoaXMubGV4ZXIuc3RhdGUuaW5MaW5rLGluUmF3QmxvY2s6dGhpcy5sZXhlci5zdGF0ZS5pblJhd0Jsb2NrLGJsb2NrOiExLHRleHQ6dFswXX19bGluayhlKXtjb25zdCB0PXRoaXMucnVsZXMuaW5saW5lLmxpbmsuZXhlYyhlKTtpZih0KXtjb25zdCBlPXRbMl0udHJpbSgpO2lmKCF0aGlzLm9wdGlvbnMucGVkYW50aWMmJnRoaXMucnVsZXMub3RoZXIuc3RhcnRBbmdsZUJyYWNrZXQudGVzdChlKSl7aWYoIXRoaXMucnVsZXMub3RoZXIuZW5kQW5nbGVCcmFja2V0LnRlc3QoZSkpcmV0dXJuO2NvbnN0IHQ9WShlLnNsaWNlKDAsLTEpLCJcXCIpO2lmKChlLmxlbmd0aC10Lmxlbmd0aCklMj09MClyZXR1cm59ZWxzZXtjb25zdCBlPWZ1bmN0aW9uKGUsdCl7aWYoLTE9PT1lLmluZGV4T2YodFsxXSkpcmV0dXJuLTE7bGV0IG49MDtmb3IobGV0IHM9MDtzPGUubGVuZ3RoO3MrKylpZigiXFwiPT09ZVtzXSlzKys7ZWxzZSBpZihlW3NdPT09dFswXSluKys7ZWxzZSBpZihlW3NdPT09dFsxXSYmKG4tLSxuPDApKXJldHVybiBzO3JldHVybi0xfSh0WzJdLCIoKSIpO2lmKGU+LTEpe2NvbnN0IG49KDA9PT10WzBdLmluZGV4T2YoIiEiKT81OjQpK3RbMV0ubGVuZ3RoK2U7dFsyXT10WzJdLnN1YnN0cmluZygwLGUpLHRbMF09dFswXS5zdWJzdHJpbmcoMCxuKS50cmltKCksdFszXT0iIn19bGV0IG49dFsyXSxzPSIiO2lmKHRoaXMub3B0aW9ucy5wZWRhbnRpYyl7Y29uc3QgZT10aGlzLnJ1bGVzLm90aGVyLnBlZGFudGljSHJlZlRpdGxlLmV4ZWMobik7ZSYmKG49ZVsxXSxzPWVbM10pfWVsc2Ugcz10WzNdP3RbM10uc2xpY2UoMSwtMSk6IiI7cmV0dXJuIG49bi50cmltKCksdGhpcy5ydWxlcy5vdGhlci5zdGFydEFuZ2xlQnJhY2tldC50ZXN0KG4pJiYobj10aGlzLm9wdGlvbnMucGVkYW50aWMmJiF0aGlzLnJ1bGVzLm90aGVyLmVuZEFuZ2xlQnJhY2tldC50ZXN0KGUpP24uc2xpY2UoMSk6bi5zbGljZSgxLC0xKSksZWUodCx7aHJlZjpuP24ucmVwbGFjZSh0aGlzLnJ1bGVzLmlubGluZS5hbnlQdW5jdHVhdGlvbiwiJDEiKTpuLHRpdGxlOnM/cy5yZXBsYWNlKHRoaXMucnVsZXMuaW5saW5lLmFueVB1bmN0dWF0aW9uLCIkMSIpOnN9LHRbMF0sdGhpcy5sZXhlcix0aGlzLnJ1bGVzKX19cmVmbGluayhlLHQpe2xldCBuO2lmKChuPXRoaXMucnVsZXMuaW5saW5lLnJlZmxpbmsuZXhlYyhlKSl8fChuPXRoaXMucnVsZXMuaW5saW5lLm5vbGluay5leGVjKGUpKSl7Y29uc3QgZT10WyhuWzJdfHxuWzFdKS5yZXBsYWNlKHRoaXMucnVsZXMub3RoZXIubXVsdGlwbGVTcGFjZUdsb2JhbCwiICIpLnRvTG93ZXJDYXNlKCldO2lmKCFlKXtjb25zdCBlPW5bMF0uY2hhckF0KDApO3JldHVybnt0eXBlOiJ0ZXh0IixyYXc6ZSx0ZXh0OmV9fXJldHVybiBlZShuLGUsblswXSx0aGlzLmxleGVyLHRoaXMucnVsZXMpfX1lbVN0cm9uZyhlLHQsbj0iIil7bGV0IHM9dGhpcy5ydWxlcy5pbmxpbmUuZW1TdHJvbmdMRGVsaW0uZXhlYyhlKTtpZighcylyZXR1cm47aWYoc1szXSYmbi5tYXRjaCh0aGlzLnJ1bGVzLm90aGVyLnVuaWNvZGVBbHBoYU51bWVyaWMpKXJldHVybjtpZighKHNbMV18fHNbMl18fCIiKXx8IW58fHRoaXMucnVsZXMuaW5saW5lLnB1bmN0dWF0aW9uLmV4ZWMobikpe2NvbnN0IG49Wy4uLnNbMF1dLmxlbmd0aC0xO2xldCByLGksbD1uLG89MDtjb25zdCBhPSIqIj09PXNbMF1bMF0/dGhpcy5ydWxlcy5pbmxpbmUuZW1TdHJvbmdSRGVsaW1Bc3Q6dGhpcy5ydWxlcy5pbmxpbmUuZW1TdHJvbmdSRGVsaW1VbmQ7Zm9yKGEubGFzdEluZGV4PTAsdD10LnNsaWNlKC0xKmUubGVuZ3RoK24pO251bGwhPShzPWEuZXhlYyh0KSk7KXtpZihyPXNbMV18fHNbMl18fHNbM118fHNbNF18fHNbNV18fHNbNl0sIXIpY29udGludWU7aWYoaT1bLi4ucl0ubGVuZ3RoLHNbM118fHNbNF0pe2wrPWk7Y29udGludWV9aWYoKHNbNV18fHNbNl0pJiZuJTMmJiEoKG4raSklMykpe28rPWk7Y29udGludWV9aWYobC09aSxsPjApY29udGludWU7aT1NYXRoLm1pbihpLGkrbCtvKTtjb25zdCB0PVsuLi5zWzBdXVswXS5sZW5ndGgsYT1lLnNsaWNlKDAsbitzLmluZGV4K3QraSk7aWYoTWF0aC5taW4obixpKSUyKXtjb25zdCBlPWEuc2xpY2UoMSwtMSk7cmV0dXJue3R5cGU6ImVtIixyYXc6YSx0ZXh0OmUsdG9rZW5zOnRoaXMubGV4ZXIuaW5saW5lVG9rZW5zKGUpfX1jb25zdCBjPWEuc2xpY2UoMiwtMik7cmV0dXJue3R5cGU6InN0cm9uZyIscmF3OmEsdGV4dDpjLHRva2Vuczp0aGlzLmxleGVyLmlubGluZVRva2VucyhjKX19fX1jb2Rlc3BhbihlKXtjb25zdCB0PXRoaXMucnVsZXMuaW5saW5lLmNvZGUuZXhlYyhlKTtpZih0KXtsZXQgZT10WzJdLnJlcGxhY2UodGhpcy5ydWxlcy5vdGhlci5uZXdMaW5lQ2hhckdsb2JhbCwiICIpO2NvbnN0IG49dGhpcy5ydWxlcy5vdGhlci5ub25TcGFjZUNoYXIudGVzdChlKSxzPXRoaXMucnVsZXMub3RoZXIuc3RhcnRpbmdTcGFjZUNoYXIudGVzdChlKSYmdGhpcy5ydWxlcy5vdGhlci5lbmRpbmdTcGFjZUNoYXIudGVzdChlKTtyZXR1cm4gbiYmcyYmKGU9ZS5zdWJzdHJpbmcoMSxlLmxlbmd0aC0xKSkse3R5cGU6ImNvZGVzcGFuIixyYXc6dFswXSx0ZXh0OmV9fX1icihlKXtjb25zdCB0PXRoaXMucnVsZXMuaW5saW5lLmJyLmV4ZWMoZSk7aWYodClyZXR1cm57dHlwZToiYnIiLHJhdzp0WzBdfX1kZWwoZSl7Y29uc3QgdD10aGlzLnJ1bGVzLmlubGluZS5kZWwuZXhlYyhlKTtpZih0KXJldHVybnt0eXBlOiJkZWwiLHJhdzp0WzBdLHRleHQ6dFsyXSx0b2tlbnM6dGhpcy5sZXhlci5pbmxpbmVUb2tlbnModFsyXSl9fWF1dG9saW5rKGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5pbmxpbmUuYXV0b2xpbmsuZXhlYyhlKTtpZih0KXtsZXQgZSxuO3JldHVybiJAIj09PXRbMl0/KGU9dFsxXSxuPSJtYWlsdG86IitlKTooZT10WzFdLG49ZSkse3R5cGU6ImxpbmsiLHJhdzp0WzBdLHRleHQ6ZSxocmVmOm4sdG9rZW5zOlt7dHlwZToidGV4dCIscmF3OmUsdGV4dDplfV19fX11cmwoZSl7bGV0IHQ7aWYodD10aGlzLnJ1bGVzLmlubGluZS51cmwuZXhlYyhlKSl7bGV0IGUsbjtpZigiQCI9PT10WzJdKWU9dFswXSxuPSJtYWlsdG86IitlO2Vsc2V7bGV0IHM7ZG97cz10WzBdLHRbMF09dGhpcy5ydWxlcy5pbmxpbmUuX2JhY2twZWRhbC5leGVjKHRbMF0pPy5bMF0/PyIifXdoaWxlKHMhPT10WzBdKTtlPXRbMF0sbj0id3d3LiI9PT10WzFdPyJodHRwOi8vIit0WzBdOnRbMF19cmV0dXJue3R5cGU6ImxpbmsiLHJhdzp0WzBdLHRleHQ6ZSxocmVmOm4sdG9rZW5zOlt7dHlwZToidGV4dCIscmF3OmUsdGV4dDplfV19fX1pbmxpbmVUZXh0KGUpe2NvbnN0IHQ9dGhpcy5ydWxlcy5pbmxpbmUudGV4dC5leGVjKGUpO2lmKHQpe2NvbnN0IGU9dGhpcy5sZXhlci5zdGF0ZS5pblJhd0Jsb2NrO3JldHVybnt0eXBlOiJ0ZXh0IixyYXc6dFswXSx0ZXh0OnRbMF0sZXNjYXBlZDplfX19fWNsYXNzIG5le3Rva2VucztvcHRpb25zO3N0YXRlO3Rva2VuaXplcjtpbmxpbmVRdWV1ZTtjb25zdHJ1Y3Rvcih0KXt0aGlzLnRva2Vucz1bXSx0aGlzLnRva2Vucy5saW5rcz1PYmplY3QuY3JlYXRlKG51bGwpLHRoaXMub3B0aW9ucz10fHxlLmRlZmF1bHRzLHRoaXMub3B0aW9ucy50b2tlbml6ZXI9dGhpcy5vcHRpb25zLnRva2VuaXplcnx8bmV3IHRlLHRoaXMudG9rZW5pemVyPXRoaXMub3B0aW9ucy50b2tlbml6ZXIsdGhpcy50b2tlbml6ZXIub3B0aW9ucz10aGlzLm9wdGlvbnMsdGhpcy50b2tlbml6ZXIubGV4ZXI9dGhpcyx0aGlzLmlubGluZVF1ZXVlPVtdLHRoaXMuc3RhdGU9e2luTGluazohMSxpblJhd0Jsb2NrOiExLHRvcDohMH07Y29uc3Qgbj17b3RoZXI6aSxibG9jazpYLm5vcm1hbCxpbmxpbmU6Ri5ub3JtYWx9O3RoaXMub3B0aW9ucy5wZWRhbnRpYz8obi5ibG9jaz1YLnBlZGFudGljLG4uaW5saW5lPUYucGVkYW50aWMpOnRoaXMub3B0aW9ucy5nZm0mJihuLmJsb2NrPVguZ2ZtLHRoaXMub3B0aW9ucy5icmVha3M/bi5pbmxpbmU9Ri5icmVha3M6bi5pbmxpbmU9Ri5nZm0pLHRoaXMudG9rZW5pemVyLnJ1bGVzPW59c3RhdGljIGdldCBydWxlcygpe3JldHVybntibG9jazpYLGlubGluZTpGfX1zdGF0aWMgbGV4KGUsdCl7cmV0dXJuIG5ldyBuZSh0KS5sZXgoZSl9c3RhdGljIGxleElubGluZShlLHQpe3JldHVybiBuZXcgbmUodCkuaW5saW5lVG9rZW5zKGUpfWxleChlKXtlPWUucmVwbGFjZShpLmNhcnJpYWdlUmV0dXJuLCJcbiIpLHRoaXMuYmxvY2tUb2tlbnMoZSx0aGlzLnRva2Vucyk7Zm9yKGxldCBlPTA7ZTx0aGlzLmlubGluZVF1ZXVlLmxlbmd0aDtlKyspe2NvbnN0IHQ9dGhpcy5pbmxpbmVRdWV1ZVtlXTt0aGlzLmlubGluZVRva2Vucyh0LnNyYyx0LnRva2Vucyl9cmV0dXJuIHRoaXMuaW5saW5lUXVldWU9W10sdGhpcy50b2tlbnN9YmxvY2tUb2tlbnMoZSx0PVtdLG49ITEpe2Zvcih0aGlzLm9wdGlvbnMucGVkYW50aWMmJihlPWUucmVwbGFjZShpLnRhYkNoYXJHbG9iYWwsIiAgICAiKS5yZXBsYWNlKGkuc3BhY2VMaW5lLCIiKSk7ZTspe2xldCBzO2lmKHRoaXMub3B0aW9ucy5leHRlbnNpb25zPy5ibG9jaz8uc29tZSgobj0+ISEocz1uLmNhbGwoe2xleGVyOnRoaXN9LGUsdCkpJiYoZT1lLnN1YnN0cmluZyhzLnJhdy5sZW5ndGgpLHQucHVzaChzKSwhMCkpKSljb250aW51ZTtpZihzPXRoaXMudG9rZW5pemVyLnNwYWNlKGUpKXtlPWUuc3Vic3RyaW5nKHMucmF3Lmxlbmd0aCk7Y29uc3Qgbj10LmF0KC0xKTsxPT09cy5yYXcubGVuZ3RoJiZ2b2lkIDAhPT1uP24ucmF3Kz0iXG4iOnQucHVzaChzKTtjb250aW51ZX1pZihzPXRoaXMudG9rZW5pemVyLmNvZGUoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKTtjb25zdCBuPXQuYXQoLTEpOyJwYXJhZ3JhcGgiPT09bj8udHlwZXx8InRleHQiPT09bj8udHlwZT8obi5yYXcrPSJcbiIrcy5yYXcsbi50ZXh0Kz0iXG4iK3MudGV4dCx0aGlzLmlubGluZVF1ZXVlLmF0KC0xKS5zcmM9bi50ZXh0KTp0LnB1c2gocyk7Y29udGludWV9aWYocz10aGlzLnRva2VuaXplci5mZW5jZXMoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyk7Y29udGludWV9aWYocz10aGlzLnRva2VuaXplci5oZWFkaW5nKGUpKXtlPWUuc3Vic3RyaW5nKHMucmF3Lmxlbmd0aCksdC5wdXNoKHMpO2NvbnRpbnVlfWlmKHM9dGhpcy50b2tlbml6ZXIuaHIoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyk7Y29udGludWV9aWYocz10aGlzLnRva2VuaXplci5ibG9ja3F1b3RlKGUpKXtlPWUuc3Vic3RyaW5nKHMucmF3Lmxlbmd0aCksdC5wdXNoKHMpO2NvbnRpbnVlfWlmKHM9dGhpcy50b2tlbml6ZXIubGlzdChlKSl7ZT1lLnN1YnN0cmluZyhzLnJhdy5sZW5ndGgpLHQucHVzaChzKTtjb250aW51ZX1pZihzPXRoaXMudG9rZW5pemVyLmh0bWwoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyk7Y29udGludWV9aWYocz10aGlzLnRva2VuaXplci5kZWYoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKTtjb25zdCBuPXQuYXQoLTEpOyJwYXJhZ3JhcGgiPT09bj8udHlwZXx8InRleHQiPT09bj8udHlwZT8obi5yYXcrPSJcbiIrcy5yYXcsbi50ZXh0Kz0iXG4iK3MucmF3LHRoaXMuaW5saW5lUXVldWUuYXQoLTEpLnNyYz1uLnRleHQpOnRoaXMudG9rZW5zLmxpbmtzW3MudGFnXXx8KHRoaXMudG9rZW5zLmxpbmtzW3MudGFnXT17aHJlZjpzLmhyZWYsdGl0bGU6cy50aXRsZX0pO2NvbnRpbnVlfWlmKHM9dGhpcy50b2tlbml6ZXIudGFibGUoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyk7Y29udGludWV9aWYocz10aGlzLnRva2VuaXplci5saGVhZGluZyhlKSl7ZT1lLnN1YnN0cmluZyhzLnJhdy5sZW5ndGgpLHQucHVzaChzKTtjb250aW51ZX1sZXQgcj1lO2lmKHRoaXMub3B0aW9ucy5leHRlbnNpb25zPy5zdGFydEJsb2NrKXtsZXQgdD0xLzA7Y29uc3Qgbj1lLnNsaWNlKDEpO2xldCBzO3RoaXMub3B0aW9ucy5leHRlbnNpb25zLnN0YXJ0QmxvY2suZm9yRWFjaCgoZT0+e3M9ZS5jYWxsKHtsZXhlcjp0aGlzfSxuKSwibnVtYmVyIj09dHlwZW9mIHMmJnM+PTAmJih0PU1hdGgubWluKHQscykpfSkpLHQ8MS8wJiZ0Pj0wJiYocj1lLnN1YnN0cmluZygwLHQrMSkpfWlmKHRoaXMuc3RhdGUudG9wJiYocz10aGlzLnRva2VuaXplci5wYXJhZ3JhcGgocikpKXtjb25zdCBpPXQuYXQoLTEpO24mJiJwYXJhZ3JhcGgiPT09aT8udHlwZT8oaS5yYXcrPSJcbiIrcy5yYXcsaS50ZXh0Kz0iXG4iK3MudGV4dCx0aGlzLmlubGluZVF1ZXVlLnBvcCgpLHRoaXMuaW5saW5lUXVldWUuYXQoLTEpLnNyYz1pLnRleHQpOnQucHVzaChzKSxuPXIubGVuZ3RoIT09ZS5sZW5ndGgsZT1lLnN1YnN0cmluZyhzLnJhdy5sZW5ndGgpfWVsc2UgaWYocz10aGlzLnRva2VuaXplci50ZXh0KGUpKXtlPWUuc3Vic3RyaW5nKHMucmF3Lmxlbmd0aCk7Y29uc3Qgbj10LmF0KC0xKTsidGV4dCI9PT1uPy50eXBlPyhuLnJhdys9IlxuIitzLnJhdyxuLnRleHQrPSJcbiIrcy50ZXh0LHRoaXMuaW5saW5lUXVldWUucG9wKCksdGhpcy5pbmxpbmVRdWV1ZS5hdCgtMSkuc3JjPW4udGV4dCk6dC5wdXNoKHMpfWVsc2UgaWYoZSl7Y29uc3QgdD0iSW5maW5pdGUgbG9vcCBvbiBieXRlOiAiK2UuY2hhckNvZGVBdCgwKTtpZih0aGlzLm9wdGlvbnMuc2lsZW50KXtjb25zb2xlLmVycm9yKHQpO2JyZWFrfXRocm93IG5ldyBFcnJvcih0KX19cmV0dXJuIHRoaXMuc3RhdGUudG9wPSEwLHR9aW5saW5lKGUsdD1bXSl7cmV0dXJuIHRoaXMuaW5saW5lUXVldWUucHVzaCh7c3JjOmUsdG9rZW5zOnR9KSx0fWlubGluZVRva2VucyhlLHQ9W10pe2xldCBuPWUscz1udWxsO2lmKHRoaXMudG9rZW5zLmxpbmtzKXtjb25zdCBlPU9iamVjdC5rZXlzKHRoaXMudG9rZW5zLmxpbmtzKTtpZihlLmxlbmd0aD4wKWZvcig7bnVsbCE9KHM9dGhpcy50b2tlbml6ZXIucnVsZXMuaW5saW5lLnJlZmxpbmtTZWFyY2guZXhlYyhuKSk7KWUuaW5jbHVkZXMoc1swXS5zbGljZShzWzBdLmxhc3RJbmRleE9mKCJbIikrMSwtMSkpJiYobj1uLnNsaWNlKDAscy5pbmRleCkrIlsiKyJhIi5yZXBlYXQoc1swXS5sZW5ndGgtMikrIl0iK24uc2xpY2UodGhpcy50b2tlbml6ZXIucnVsZXMuaW5saW5lLnJlZmxpbmtTZWFyY2gubGFzdEluZGV4KSl9Zm9yKDtudWxsIT0ocz10aGlzLnRva2VuaXplci5ydWxlcy5pbmxpbmUuYmxvY2tTa2lwLmV4ZWMobikpOyluPW4uc2xpY2UoMCxzLmluZGV4KSsiWyIrImEiLnJlcGVhdChzWzBdLmxlbmd0aC0yKSsiXSIrbi5zbGljZSh0aGlzLnRva2VuaXplci5ydWxlcy5pbmxpbmUuYmxvY2tTa2lwLmxhc3RJbmRleCk7Zm9yKDtudWxsIT0ocz10aGlzLnRva2VuaXplci5ydWxlcy5pbmxpbmUuYW55UHVuY3R1YXRpb24uZXhlYyhuKSk7KW49bi5zbGljZSgwLHMuaW5kZXgpKyIrKyIrbi5zbGljZSh0aGlzLnRva2VuaXplci5ydWxlcy5pbmxpbmUuYW55UHVuY3R1YXRpb24ubGFzdEluZGV4KTtsZXQgcj0hMSxpPSIiO2Zvcig7ZTspe2xldCBzO2lmKHJ8fChpPSIiKSxyPSExLHRoaXMub3B0aW9ucy5leHRlbnNpb25zPy5pbmxpbmU/LnNvbWUoKG49PiEhKHM9bi5jYWxsKHtsZXhlcjp0aGlzfSxlLHQpKSYmKGU9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyksITApKSkpY29udGludWU7aWYocz10aGlzLnRva2VuaXplci5lc2NhcGUoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyk7Y29udGludWV9aWYocz10aGlzLnRva2VuaXplci50YWcoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyk7Y29udGludWV9aWYocz10aGlzLnRva2VuaXplci5saW5rKGUpKXtlPWUuc3Vic3RyaW5nKHMucmF3Lmxlbmd0aCksdC5wdXNoKHMpO2NvbnRpbnVlfWlmKHM9dGhpcy50b2tlbml6ZXIucmVmbGluayhlLHRoaXMudG9rZW5zLmxpbmtzKSl7ZT1lLnN1YnN0cmluZyhzLnJhdy5sZW5ndGgpO2NvbnN0IG49dC5hdCgtMSk7InRleHQiPT09cy50eXBlJiYidGV4dCI9PT1uPy50eXBlPyhuLnJhdys9cy5yYXcsbi50ZXh0Kz1zLnRleHQpOnQucHVzaChzKTtjb250aW51ZX1pZihzPXRoaXMudG9rZW5pemVyLmVtU3Ryb25nKGUsbixpKSl7ZT1lLnN1YnN0cmluZyhzLnJhdy5sZW5ndGgpLHQucHVzaChzKTtjb250aW51ZX1pZihzPXRoaXMudG9rZW5pemVyLmNvZGVzcGFuKGUpKXtlPWUuc3Vic3RyaW5nKHMucmF3Lmxlbmd0aCksdC5wdXNoKHMpO2NvbnRpbnVlfWlmKHM9dGhpcy50b2tlbml6ZXIuYnIoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyk7Y29udGludWV9aWYocz10aGlzLnRva2VuaXplci5kZWwoZSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyk7Y29udGludWV9aWYocz10aGlzLnRva2VuaXplci5hdXRvbGluayhlKSl7ZT1lLnN1YnN0cmluZyhzLnJhdy5sZW5ndGgpLHQucHVzaChzKTtjb250aW51ZX1pZighdGhpcy5zdGF0ZS5pbkxpbmsmJihzPXRoaXMudG9rZW5pemVyLnVybChlKSkpe2U9ZS5zdWJzdHJpbmcocy5yYXcubGVuZ3RoKSx0LnB1c2gocyk7Y29udGludWV9bGV0IGw9ZTtpZih0aGlzLm9wdGlvbnMuZXh0ZW5zaW9ucz8uc3RhcnRJbmxpbmUpe2xldCB0PTEvMDtjb25zdCBuPWUuc2xpY2UoMSk7bGV0IHM7dGhpcy5vcHRpb25zLmV4dGVuc2lvbnMuc3RhcnRJbmxpbmUuZm9yRWFjaCgoZT0+e3M9ZS5jYWxsKHtsZXhlcjp0aGlzfSxuKSwibnVtYmVyIj09dHlwZW9mIHMmJnM+PTAmJih0PU1hdGgubWluKHQscykpfSkpLHQ8MS8wJiZ0Pj0wJiYobD1lLnN1YnN0cmluZygwLHQrMSkpfWlmKHM9dGhpcy50b2tlbml6ZXIuaW5saW5lVGV4dChsKSl7ZT1lLnN1YnN0cmluZyhzLnJhdy5sZW5ndGgpLCJfIiE9PXMucmF3LnNsaWNlKC0xKSYmKGk9cy5yYXcuc2xpY2UoLTEpKSxyPSEwO2NvbnN0IG49dC5hdCgtMSk7InRleHQiPT09bj8udHlwZT8obi5yYXcrPXMucmF3LG4udGV4dCs9cy50ZXh0KTp0LnB1c2gocyl9ZWxzZSBpZihlKXtjb25zdCB0PSJJbmZpbml0ZSBsb29wIG9uIGJ5dGU6ICIrZS5jaGFyQ29kZUF0KDApO2lmKHRoaXMub3B0aW9ucy5zaWxlbnQpe2NvbnNvbGUuZXJyb3IodCk7YnJlYWt9dGhyb3cgbmV3IEVycm9yKHQpfX1yZXR1cm4gdH19Y2xhc3Mgc2V7b3B0aW9ucztwYXJzZXI7Y29uc3RydWN0b3IodCl7dGhpcy5vcHRpb25zPXR8fGUuZGVmYXVsdHN9c3BhY2UoZSl7cmV0dXJuIiJ9Y29kZSh7dGV4dDplLGxhbmc6dCxlc2NhcGVkOm59KXtjb25zdCBzPSh0fHwiIikubWF0Y2goaS5ub3RTcGFjZVN0YXJ0KT8uWzBdLHI9ZS5yZXBsYWNlKGkuZW5kaW5nTmV3bGluZSwiIikrIlxuIjtyZXR1cm4gcz8nPHByZT48Y29kZSBjbGFzcz0ibGFuZ3VhZ2UtJytLKHMpKyciPicrKG4/cjpLKHIsITApKSsiPC9jb2RlPjwvcHJlPlxuIjoiPHByZT48Y29kZT4iKyhuP3I6SyhyLCEwKSkrIjwvY29kZT48L3ByZT5cbiJ9YmxvY2txdW90ZSh7dG9rZW5zOmV9KXtyZXR1cm5gPGJsb2NrcXVvdGU+XG4ke3RoaXMucGFyc2VyLnBhcnNlKGUpfTwvYmxvY2txdW90ZT5cbmB9aHRtbCh7dGV4dDplfSl7cmV0dXJuIGV9aGVhZGluZyh7dG9rZW5zOmUsZGVwdGg6dH0pe3JldHVybmA8aCR7dH0+JHt0aGlzLnBhcnNlci5wYXJzZUlubGluZShlKX08L2gke3R9PlxuYH1ocihlKXtyZXR1cm4iPGhyPlxuIn1saXN0KGUpe2NvbnN0IHQ9ZS5vcmRlcmVkLG49ZS5zdGFydDtsZXQgcz0iIjtmb3IobGV0IHQ9MDt0PGUuaXRlbXMubGVuZ3RoO3QrKyl7Y29uc3Qgbj1lLml0ZW1zW3RdO3MrPXRoaXMubGlzdGl0ZW0obil9Y29uc3Qgcj10PyJvbCI6InVsIjtyZXR1cm4iPCIrcisodCYmMSE9PW4/JyBzdGFydD0iJytuKyciJzoiIikrIj5cbiIrcysiPC8iK3IrIj5cbiJ9bGlzdGl0ZW0oZSl7bGV0IHQ9IiI7aWYoZS50YXNrKXtjb25zdCBuPXRoaXMuY2hlY2tib3goe2NoZWNrZWQ6ISFlLmNoZWNrZWR9KTtlLmxvb3NlPyJwYXJhZ3JhcGgiPT09ZS50b2tlbnNbMF0/LnR5cGU/KGUudG9rZW5zWzBdLnRleHQ9bisiICIrZS50b2tlbnNbMF0udGV4dCxlLnRva2Vuc1swXS50b2tlbnMmJmUudG9rZW5zWzBdLnRva2Vucy5sZW5ndGg+MCYmInRleHQiPT09ZS50b2tlbnNbMF0udG9rZW5zWzBdLnR5cGUmJihlLnRva2Vuc1swXS50b2tlbnNbMF0udGV4dD1uKyIgIitLKGUudG9rZW5zWzBdLnRva2Vuc1swXS50ZXh0KSxlLnRva2Vuc1swXS50b2tlbnNbMF0uZXNjYXBlZD0hMCkpOmUudG9rZW5zLnVuc2hpZnQoe3R5cGU6InRleHQiLHJhdzpuKyIgIix0ZXh0Om4rIiAiLGVzY2FwZWQ6ITB9KTp0Kz1uKyIgIn1yZXR1cm4gdCs9dGhpcy5wYXJzZXIucGFyc2UoZS50b2tlbnMsISFlLmxvb3NlKSxgPGxpPiR7dH08L2xpPlxuYH1jaGVja2JveCh7Y2hlY2tlZDplfSl7cmV0dXJuIjxpbnB1dCAiKyhlPydjaGVja2VkPSIiICc6IiIpKydkaXNhYmxlZD0iIiB0eXBlPSJjaGVja2JveCI+J31wYXJhZ3JhcGgoe3Rva2VuczplfSl7cmV0dXJuYDxwPiR7dGhpcy5wYXJzZXIucGFyc2VJbmxpbmUoZSl9PC9wPlxuYH10YWJsZShlKXtsZXQgdD0iIixuPSIiO2ZvcihsZXQgdD0wO3Q8ZS5oZWFkZXIubGVuZ3RoO3QrKyluKz10aGlzLnRhYmxlY2VsbChlLmhlYWRlclt0XSk7dCs9dGhpcy50YWJsZXJvdyh7dGV4dDpufSk7bGV0IHM9IiI7Zm9yKGxldCB0PTA7dDxlLnJvd3MubGVuZ3RoO3QrKyl7Y29uc3Qgcj1lLnJvd3NbdF07bj0iIjtmb3IobGV0IGU9MDtlPHIubGVuZ3RoO2UrKyluKz10aGlzLnRhYmxlY2VsbChyW2VdKTtzKz10aGlzLnRhYmxlcm93KHt0ZXh0Om59KX1yZXR1cm4gcyYmKHM9YDx0Ym9keT4ke3N9PC90Ym9keT5gKSwiPHRhYmxlPlxuPHRoZWFkPlxuIit0KyI8L3RoZWFkPlxuIitzKyI8L3RhYmxlPlxuIn10YWJsZXJvdyh7dGV4dDplfSl7cmV0dXJuYDx0cj5cbiR7ZX08L3RyPlxuYH10YWJsZWNlbGwoZSl7Y29uc3QgdD10aGlzLnBhcnNlci5wYXJzZUlubGluZShlLnRva2Vucyksbj1lLmhlYWRlcj8idGgiOiJ0ZCI7cmV0dXJuKGUuYWxpZ24/YDwke259IGFsaWduPSIke2UuYWxpZ259Ij5gOmA8JHtufT5gKSt0K2A8LyR7bn0+XG5gfXN0cm9uZyh7dG9rZW5zOmV9KXtyZXR1cm5gPHN0cm9uZz4ke3RoaXMucGFyc2VyLnBhcnNlSW5saW5lKGUpfTwvc3Ryb25nPmB9ZW0oe3Rva2VuczplfSl7cmV0dXJuYDxlbT4ke3RoaXMucGFyc2VyLnBhcnNlSW5saW5lKGUpfTwvZW0+YH1jb2Rlc3Bhbih7dGV4dDplfSl7cmV0dXJuYDxjb2RlPiR7SyhlLCEwKX08L2NvZGU+YH1icihlKXtyZXR1cm4iPGJyPiJ9ZGVsKHt0b2tlbnM6ZX0pe3JldHVybmA8ZGVsPiR7dGhpcy5wYXJzZXIucGFyc2VJbmxpbmUoZSl9PC9kZWw+YH1saW5rKHtocmVmOmUsdGl0bGU6dCx0b2tlbnM6bn0pe2NvbnN0IHM9dGhpcy5wYXJzZXIucGFyc2VJbmxpbmUobikscj1WKGUpO2lmKG51bGw9PT1yKXJldHVybiBzO2xldCBpPSc8YSBocmVmPSInKyhlPXIpKyciJztyZXR1cm4gdCYmKGkrPScgdGl0bGU9IicrSyh0KSsnIicpLGkrPSI+IitzKyI8L2E+IixpfWltYWdlKHtocmVmOmUsdGl0bGU6dCx0ZXh0Om59KXtjb25zdCBzPVYoZSk7aWYobnVsbD09PXMpcmV0dXJuIEsobik7bGV0IHI9YDxpbWcgc3JjPSIke2U9c30iIGFsdD0iJHtufSJgO3JldHVybiB0JiYocis9YCB0aXRsZT0iJHtLKHQpfSJgKSxyKz0iPiIscn10ZXh0KGUpe3JldHVybiJ0b2tlbnMiaW4gZSYmZS50b2tlbnM/dGhpcy5wYXJzZXIucGFyc2VJbmxpbmUoZS50b2tlbnMpOiJlc2NhcGVkImluIGUmJmUuZXNjYXBlZD9lLnRleHQ6SyhlLnRleHQpfX1jbGFzcyByZXtzdHJvbmcoe3RleHQ6ZX0pe3JldHVybiBlfWVtKHt0ZXh0OmV9KXtyZXR1cm4gZX1jb2Rlc3Bhbih7dGV4dDplfSl7cmV0dXJuIGV9ZGVsKHt0ZXh0OmV9KXtyZXR1cm4gZX1odG1sKHt0ZXh0OmV9KXtyZXR1cm4gZX10ZXh0KHt0ZXh0OmV9KXtyZXR1cm4gZX1saW5rKHt0ZXh0OmV9KXtyZXR1cm4iIitlfWltYWdlKHt0ZXh0OmV9KXtyZXR1cm4iIitlfWJyKCl7cmV0dXJuIiJ9fWNsYXNzIGlle29wdGlvbnM7cmVuZGVyZXI7dGV4dFJlbmRlcmVyO2NvbnN0cnVjdG9yKHQpe3RoaXMub3B0aW9ucz10fHxlLmRlZmF1bHRzLHRoaXMub3B0aW9ucy5yZW5kZXJlcj10aGlzLm9wdGlvbnMucmVuZGVyZXJ8fG5ldyBzZSx0aGlzLnJlbmRlcmVyPXRoaXMub3B0aW9ucy5yZW5kZXJlcix0aGlzLnJlbmRlcmVyLm9wdGlvbnM9dGhpcy5vcHRpb25zLHRoaXMucmVuZGVyZXIucGFyc2VyPXRoaXMsdGhpcy50ZXh0UmVuZGVyZXI9bmV3IHJlfXN0YXRpYyBwYXJzZShlLHQpe3JldHVybiBuZXcgaWUodCkucGFyc2UoZSl9c3RhdGljIHBhcnNlSW5saW5lKGUsdCl7cmV0dXJuIG5ldyBpZSh0KS5wYXJzZUlubGluZShlKX1wYXJzZShlLHQ9ITApe2xldCBuPSIiO2ZvcihsZXQgcz0wO3M8ZS5sZW5ndGg7cysrKXtjb25zdCByPWVbc107aWYodGhpcy5vcHRpb25zLmV4dGVuc2lvbnM/LnJlbmRlcmVycz8uW3IudHlwZV0pe2NvbnN0IGU9cix0PXRoaXMub3B0aW9ucy5leHRlbnNpb25zLnJlbmRlcmVyc1tlLnR5cGVdLmNhbGwoe3BhcnNlcjp0aGlzfSxlKTtpZighMSE9PXR8fCFbInNwYWNlIiwiaHIiLCJoZWFkaW5nIiwiY29kZSIsInRhYmxlIiwiYmxvY2txdW90ZSIsImxpc3QiLCJodG1sIiwicGFyYWdyYXBoIiwidGV4dCJdLmluY2x1ZGVzKGUudHlwZSkpe24rPXR8fCIiO2NvbnRpbnVlfX1jb25zdCBpPXI7c3dpdGNoKGkudHlwZSl7Y2FzZSJzcGFjZSI6bis9dGhpcy5yZW5kZXJlci5zcGFjZShpKTtjb250aW51ZTtjYXNlImhyIjpuKz10aGlzLnJlbmRlcmVyLmhyKGkpO2NvbnRpbnVlO2Nhc2UiaGVhZGluZyI6bis9dGhpcy5yZW5kZXJlci5oZWFkaW5nKGkpO2NvbnRpbnVlO2Nhc2UiY29kZSI6bis9dGhpcy5yZW5kZXJlci5jb2RlKGkpO2NvbnRpbnVlO2Nhc2UidGFibGUiOm4rPXRoaXMucmVuZGVyZXIudGFibGUoaSk7Y29udGludWU7Y2FzZSJibG9ja3F1b3RlIjpuKz10aGlzLnJlbmRlcmVyLmJsb2NrcXVvdGUoaSk7Y29udGludWU7Y2FzZSJsaXN0IjpuKz10aGlzLnJlbmRlcmVyLmxpc3QoaSk7Y29udGludWU7Y2FzZSJodG1sIjpuKz10aGlzLnJlbmRlcmVyLmh0bWwoaSk7Y29udGludWU7Y2FzZSJwYXJhZ3JhcGgiOm4rPXRoaXMucmVuZGVyZXIucGFyYWdyYXBoKGkpO2NvbnRpbnVlO2Nhc2UidGV4dCI6e2xldCByPWksbD10aGlzLnJlbmRlcmVyLnRleHQocik7Zm9yKDtzKzE8ZS5sZW5ndGgmJiJ0ZXh0Ij09PWVbcysxXS50eXBlOylyPWVbKytzXSxsKz0iXG4iK3RoaXMucmVuZGVyZXIudGV4dChyKTtuKz10P3RoaXMucmVuZGVyZXIucGFyYWdyYXBoKHt0eXBlOiJwYXJhZ3JhcGgiLHJhdzpsLHRleHQ6bCx0b2tlbnM6W3t0eXBlOiJ0ZXh0IixyYXc6bCx0ZXh0OmwsZXNjYXBlZDohMH1dfSk6bDtjb250aW51ZX1kZWZhdWx0Ontjb25zdCBlPSdUb2tlbiB3aXRoICInK2kudHlwZSsnIiB0eXBlIHdhcyBub3QgZm91bmQuJztpZih0aGlzLm9wdGlvbnMuc2lsZW50KXJldHVybiBjb25zb2xlLmVycm9yKGUpLCIiO3Rocm93IG5ldyBFcnJvcihlKX19fXJldHVybiBufXBhcnNlSW5saW5lKGUsdD10aGlzLnJlbmRlcmVyKXtsZXQgbj0iIjtmb3IobGV0IHM9MDtzPGUubGVuZ3RoO3MrKyl7Y29uc3Qgcj1lW3NdO2lmKHRoaXMub3B0aW9ucy5leHRlbnNpb25zPy5yZW5kZXJlcnM/LltyLnR5cGVdKXtjb25zdCBlPXRoaXMub3B0aW9ucy5leHRlbnNpb25zLnJlbmRlcmVyc1tyLnR5cGVdLmNhbGwoe3BhcnNlcjp0aGlzfSxyKTtpZighMSE9PWV8fCFbImVzY2FwZSIsImh0bWwiLCJsaW5rIiwiaW1hZ2UiLCJzdHJvbmciLCJlbSIsImNvZGVzcGFuIiwiYnIiLCJkZWwiLCJ0ZXh0Il0uaW5jbHVkZXMoci50eXBlKSl7bis9ZXx8IiI7Y29udGludWV9fWNvbnN0IGk9cjtzd2l0Y2goaS50eXBlKXtjYXNlImVzY2FwZSI6Y2FzZSJ0ZXh0IjpuKz10LnRleHQoaSk7YnJlYWs7Y2FzZSJodG1sIjpuKz10Lmh0bWwoaSk7YnJlYWs7Y2FzZSJsaW5rIjpuKz10LmxpbmsoaSk7YnJlYWs7Y2FzZSJpbWFnZSI6bis9dC5pbWFnZShpKTticmVhaztjYXNlInN0cm9uZyI6bis9dC5zdHJvbmcoaSk7YnJlYWs7Y2FzZSJlbSI6bis9dC5lbShpKTticmVhaztjYXNlImNvZGVzcGFuIjpuKz10LmNvZGVzcGFuKGkpO2JyZWFrO2Nhc2UiYnIiOm4rPXQuYnIoaSk7YnJlYWs7Y2FzZSJkZWwiOm4rPXQuZGVsKGkpO2JyZWFrO2RlZmF1bHQ6e2NvbnN0IGU9J1Rva2VuIHdpdGggIicraS50eXBlKyciIHR5cGUgd2FzIG5vdCBmb3VuZC4nO2lmKHRoaXMub3B0aW9ucy5zaWxlbnQpcmV0dXJuIGNvbnNvbGUuZXJyb3IoZSksIiI7dGhyb3cgbmV3IEVycm9yKGUpfX19cmV0dXJuIG59fWNsYXNzIGxle29wdGlvbnM7YmxvY2s7Y29uc3RydWN0b3IodCl7dGhpcy5vcHRpb25zPXR8fGUuZGVmYXVsdHN9c3RhdGljIHBhc3NUaHJvdWdoSG9va3M9bmV3IFNldChbInByZXByb2Nlc3MiLCJwb3N0cHJvY2VzcyIsInByb2Nlc3NBbGxUb2tlbnMiXSk7cHJlcHJvY2VzcyhlKXtyZXR1cm4gZX1wb3N0cHJvY2VzcyhlKXtyZXR1cm4gZX1wcm9jZXNzQWxsVG9rZW5zKGUpe3JldHVybiBlfXByb3ZpZGVMZXhlcigpe3JldHVybiB0aGlzLmJsb2NrP25lLmxleDpuZS5sZXhJbmxpbmV9cHJvdmlkZVBhcnNlcigpe3JldHVybiB0aGlzLmJsb2NrP2llLnBhcnNlOmllLnBhcnNlSW5saW5lfX1jbGFzcyBvZXtkZWZhdWx0cz17YXN5bmM6ITEsYnJlYWtzOiExLGV4dGVuc2lvbnM6bnVsbCxnZm06ITAsaG9va3M6bnVsbCxwZWRhbnRpYzohMSxyZW5kZXJlcjpudWxsLHNpbGVudDohMSx0b2tlbml6ZXI6bnVsbCx3YWxrVG9rZW5zOm51bGx9O29wdGlvbnM9dGhpcy5zZXRPcHRpb25zO3BhcnNlPXRoaXMucGFyc2VNYXJrZG93bighMCk7cGFyc2VJbmxpbmU9dGhpcy5wYXJzZU1hcmtkb3duKCExKTtQYXJzZXI9aWU7UmVuZGVyZXI9c2U7VGV4dFJlbmRlcmVyPXJlO0xleGVyPW5lO1Rva2VuaXplcj10ZTtIb29rcz1sZTtjb25zdHJ1Y3RvciguLi5lKXt0aGlzLnVzZSguLi5lKX13YWxrVG9rZW5zKGUsdCl7bGV0IG49W107Zm9yKGNvbnN0IHMgb2YgZSlzd2l0Y2gobj1uLmNvbmNhdCh0LmNhbGwodGhpcyxzKSkscy50eXBlKXtjYXNlInRhYmxlIjp7Y29uc3QgZT1zO2Zvcihjb25zdCBzIG9mIGUuaGVhZGVyKW49bi5jb25jYXQodGhpcy53YWxrVG9rZW5zKHMudG9rZW5zLHQpKTtmb3IoY29uc3QgcyBvZiBlLnJvd3MpZm9yKGNvbnN0IGUgb2YgcyluPW4uY29uY2F0KHRoaXMud2Fsa1Rva2VucyhlLnRva2Vucyx0KSk7YnJlYWt9Y2FzZSJsaXN0Ijp7Y29uc3QgZT1zO249bi5jb25jYXQodGhpcy53YWxrVG9rZW5zKGUuaXRlbXMsdCkpO2JyZWFrfWRlZmF1bHQ6e2NvbnN0IGU9czt0aGlzLmRlZmF1bHRzLmV4dGVuc2lvbnM/LmNoaWxkVG9rZW5zPy5bZS50eXBlXT90aGlzLmRlZmF1bHRzLmV4dGVuc2lvbnMuY2hpbGRUb2tlbnNbZS50eXBlXS5mb3JFYWNoKChzPT57Y29uc3Qgcj1lW3NdLmZsYXQoMS8wKTtuPW4uY29uY2F0KHRoaXMud2Fsa1Rva2VucyhyLHQpKX0pKTplLnRva2VucyYmKG49bi5jb25jYXQodGhpcy53YWxrVG9rZW5zKGUudG9rZW5zLHQpKSl9fXJldHVybiBufXVzZSguLi5lKXtjb25zdCB0PXRoaXMuZGVmYXVsdHMuZXh0ZW5zaW9uc3x8e3JlbmRlcmVyczp7fSxjaGlsZFRva2Vuczp7fX07cmV0dXJuIGUuZm9yRWFjaCgoZT0+e2NvbnN0IG49ey4uLmV9O2lmKG4uYXN5bmM9dGhpcy5kZWZhdWx0cy5hc3luY3x8bi5hc3luY3x8ITEsZS5leHRlbnNpb25zJiYoZS5leHRlbnNpb25zLmZvckVhY2goKGU9PntpZighZS5uYW1lKXRocm93IG5ldyBFcnJvcigiZXh0ZW5zaW9uIG5hbWUgcmVxdWlyZWQiKTtpZigicmVuZGVyZXIiaW4gZSl7Y29uc3Qgbj10LnJlbmRlcmVyc1tlLm5hbWVdO3QucmVuZGVyZXJzW2UubmFtZV09bj9mdW5jdGlvbiguLi50KXtsZXQgcz1lLnJlbmRlcmVyLmFwcGx5KHRoaXMsdCk7cmV0dXJuITE9PT1zJiYocz1uLmFwcGx5KHRoaXMsdCkpLHN9OmUucmVuZGVyZXJ9aWYoInRva2VuaXplciJpbiBlKXtpZighZS5sZXZlbHx8ImJsb2NrIiE9PWUubGV2ZWwmJiJpbmxpbmUiIT09ZS5sZXZlbCl0aHJvdyBuZXcgRXJyb3IoImV4dGVuc2lvbiBsZXZlbCBtdXN0IGJlICdibG9jaycgb3IgJ2lubGluZSciKTtjb25zdCBuPXRbZS5sZXZlbF07bj9uLnVuc2hpZnQoZS50b2tlbml6ZXIpOnRbZS5sZXZlbF09W2UudG9rZW5pemVyXSxlLnN0YXJ0JiYoImJsb2NrIj09PWUubGV2ZWw/dC5zdGFydEJsb2NrP3Quc3RhcnRCbG9jay5wdXNoKGUuc3RhcnQpOnQuc3RhcnRCbG9jaz1bZS5zdGFydF06ImlubGluZSI9PT1lLmxldmVsJiYodC5zdGFydElubGluZT90LnN0YXJ0SW5saW5lLnB1c2goZS5zdGFydCk6dC5zdGFydElubGluZT1bZS5zdGFydF0pKX0iY2hpbGRUb2tlbnMiaW4gZSYmZS5jaGlsZFRva2VucyYmKHQuY2hpbGRUb2tlbnNbZS5uYW1lXT1lLmNoaWxkVG9rZW5zKX0pKSxuLmV4dGVuc2lvbnM9dCksZS5yZW5kZXJlcil7Y29uc3QgdD10aGlzLmRlZmF1bHRzLnJlbmRlcmVyfHxuZXcgc2UodGhpcy5kZWZhdWx0cyk7Zm9yKGNvbnN0IG4gaW4gZS5yZW5kZXJlcil7aWYoIShuIGluIHQpKXRocm93IG5ldyBFcnJvcihgcmVuZGVyZXIgJyR7bn0nIGRvZXMgbm90IGV4aXN0YCk7aWYoWyJvcHRpb25zIiwicGFyc2VyIl0uaW5jbHVkZXMobikpY29udGludWU7Y29uc3Qgcz1uLHI9ZS5yZW5kZXJlcltzXSxpPXRbc107dFtzXT0oLi4uZSk9PntsZXQgbj1yLmFwcGx5KHQsZSk7cmV0dXJuITE9PT1uJiYobj1pLmFwcGx5KHQsZSkpLG58fCIifX1uLnJlbmRlcmVyPXR9aWYoZS50b2tlbml6ZXIpe2NvbnN0IHQ9dGhpcy5kZWZhdWx0cy50b2tlbml6ZXJ8fG5ldyB0ZSh0aGlzLmRlZmF1bHRzKTtmb3IoY29uc3QgbiBpbiBlLnRva2VuaXplcil7aWYoIShuIGluIHQpKXRocm93IG5ldyBFcnJvcihgdG9rZW5pemVyICcke259JyBkb2VzIG5vdCBleGlzdGApO2lmKFsib3B0aW9ucyIsInJ1bGVzIiwibGV4ZXIiXS5pbmNsdWRlcyhuKSljb250aW51ZTtjb25zdCBzPW4scj1lLnRva2VuaXplcltzXSxpPXRbc107dFtzXT0oLi4uZSk9PntsZXQgbj1yLmFwcGx5KHQsZSk7cmV0dXJuITE9PT1uJiYobj1pLmFwcGx5KHQsZSkpLG59fW4udG9rZW5pemVyPXR9aWYoZS5ob29rcyl7Y29uc3QgdD10aGlzLmRlZmF1bHRzLmhvb2tzfHxuZXcgbGU7Zm9yKGNvbnN0IG4gaW4gZS5ob29rcyl7aWYoIShuIGluIHQpKXRocm93IG5ldyBFcnJvcihgaG9vayAnJHtufScgZG9lcyBub3QgZXhpc3RgKTtpZihbIm9wdGlvbnMiLCJibG9jayJdLmluY2x1ZGVzKG4pKWNvbnRpbnVlO2NvbnN0IHM9bixyPWUuaG9va3Nbc10saT10W3NdO2xlLnBhc3NUaHJvdWdoSG9va3MuaGFzKG4pP3Rbc109ZT0+e2lmKHRoaXMuZGVmYXVsdHMuYXN5bmMpcmV0dXJuIFByb21pc2UucmVzb2x2ZShyLmNhbGwodCxlKSkudGhlbigoZT0+aS5jYWxsKHQsZSkpKTtjb25zdCBuPXIuY2FsbCh0LGUpO3JldHVybiBpLmNhbGwodCxuKX06dFtzXT0oLi4uZSk9PntsZXQgbj1yLmFwcGx5KHQsZSk7cmV0dXJuITE9PT1uJiYobj1pLmFwcGx5KHQsZSkpLG59fW4uaG9va3M9dH1pZihlLndhbGtUb2tlbnMpe2NvbnN0IHQ9dGhpcy5kZWZhdWx0cy53YWxrVG9rZW5zLHM9ZS53YWxrVG9rZW5zO24ud2Fsa1Rva2Vucz1mdW5jdGlvbihlKXtsZXQgbj1bXTtyZXR1cm4gbi5wdXNoKHMuY2FsbCh0aGlzLGUpKSx0JiYobj1uLmNvbmNhdCh0LmNhbGwodGhpcyxlKSkpLG59fXRoaXMuZGVmYXVsdHM9ey4uLnRoaXMuZGVmYXVsdHMsLi4ubn19KSksdGhpc31zZXRPcHRpb25zKGUpe3JldHVybiB0aGlzLmRlZmF1bHRzPXsuLi50aGlzLmRlZmF1bHRzLC4uLmV9LHRoaXN9bGV4ZXIoZSx0KXtyZXR1cm4gbmUubGV4KGUsdD8/dGhpcy5kZWZhdWx0cyl9cGFyc2VyKGUsdCl7cmV0dXJuIGllLnBhcnNlKGUsdD8/dGhpcy5kZWZhdWx0cyl9cGFyc2VNYXJrZG93bihlKXtyZXR1cm4odCxuKT0+e2NvbnN0IHM9ey4uLm59LHI9ey4uLnRoaXMuZGVmYXVsdHMsLi4uc30saT10aGlzLm9uRXJyb3IoISFyLnNpbGVudCwhIXIuYXN5bmMpO2lmKCEwPT09dGhpcy5kZWZhdWx0cy5hc3luYyYmITE9PT1zLmFzeW5jKXJldHVybiBpKG5ldyBFcnJvcigibWFya2VkKCk6IFRoZSBhc3luYyBvcHRpb24gd2FzIHNldCB0byB0cnVlIGJ5IGFuIGV4dGVuc2lvbi4gUmVtb3ZlIGFzeW5jOiBmYWxzZSBmcm9tIHRoZSBwYXJzZSBvcHRpb25zIG9iamVjdCB0byByZXR1cm4gYSBQcm9taXNlLiIpKTtpZihudWxsPT10KXJldHVybiBpKG5ldyBFcnJvcigibWFya2VkKCk6IGlucHV0IHBhcmFtZXRlciBpcyB1bmRlZmluZWQgb3IgbnVsbCIpKTtpZigic3RyaW5nIiE9dHlwZW9mIHQpcmV0dXJuIGkobmV3IEVycm9yKCJtYXJrZWQoKTogaW5wdXQgcGFyYW1ldGVyIGlzIG9mIHR5cGUgIitPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodCkrIiwgc3RyaW5nIGV4cGVjdGVkIikpO3IuaG9va3MmJihyLmhvb2tzLm9wdGlvbnM9cixyLmhvb2tzLmJsb2NrPWUpO2NvbnN0IGw9ci5ob29rcz9yLmhvb2tzLnByb3ZpZGVMZXhlcigpOmU/bmUubGV4Om5lLmxleElubGluZSxvPXIuaG9va3M/ci5ob29rcy5wcm92aWRlUGFyc2VyKCk6ZT9pZS5wYXJzZTppZS5wYXJzZUlubGluZTtpZihyLmFzeW5jKXJldHVybiBQcm9taXNlLnJlc29sdmUoci5ob29rcz9yLmhvb2tzLnByZXByb2Nlc3ModCk6dCkudGhlbigoZT0+bChlLHIpKSkudGhlbigoZT0+ci5ob29rcz9yLmhvb2tzLnByb2Nlc3NBbGxUb2tlbnMoZSk6ZSkpLnRoZW4oKGU9PnIud2Fsa1Rva2Vucz9Qcm9taXNlLmFsbCh0aGlzLndhbGtUb2tlbnMoZSxyLndhbGtUb2tlbnMpKS50aGVuKCgoKT0+ZSkpOmUpKS50aGVuKChlPT5vKGUscikpKS50aGVuKChlPT5yLmhvb2tzP3IuaG9va3MucG9zdHByb2Nlc3MoZSk6ZSkpLmNhdGNoKGkpO3RyeXtyLmhvb2tzJiYodD1yLmhvb2tzLnByZXByb2Nlc3ModCkpO2xldCBlPWwodCxyKTtyLmhvb2tzJiYoZT1yLmhvb2tzLnByb2Nlc3NBbGxUb2tlbnMoZSkpLHIud2Fsa1Rva2VucyYmdGhpcy53YWxrVG9rZW5zKGUsci53YWxrVG9rZW5zKTtsZXQgbj1vKGUscik7cmV0dXJuIHIuaG9va3MmJihuPXIuaG9va3MucG9zdHByb2Nlc3MobikpLG59Y2F0Y2goZSl7cmV0dXJuIGkoZSl9fX1vbkVycm9yKGUsdCl7cmV0dXJuIG49PntpZihuLm1lc3NhZ2UrPSJcblBsZWFzZSByZXBvcnQgdGhpcyB0byBodHRwczovL2dpdGh1Yi5jb20vbWFya2VkanMvbWFya2VkLiIsZSl7Y29uc3QgZT0iPHA+QW4gZXJyb3Igb2NjdXJyZWQ6PC9wPjxwcmU+IitLKG4ubWVzc2FnZSsiIiwhMCkrIjwvcHJlPiI7cmV0dXJuIHQ/UHJvbWlzZS5yZXNvbHZlKGUpOmV9aWYodClyZXR1cm4gUHJvbWlzZS5yZWplY3Qobik7dGhyb3cgbn19fWNvbnN0IGFlPW5ldyBvZTtmdW5jdGlvbiBjZShlLHQpe3JldHVybiBhZS5wYXJzZShlLHQpfWNlLm9wdGlvbnM9Y2Uuc2V0T3B0aW9ucz1mdW5jdGlvbihlKXtyZXR1cm4gYWUuc2V0T3B0aW9ucyhlKSxjZS5kZWZhdWx0cz1hZS5kZWZhdWx0cyxuKGNlLmRlZmF1bHRzKSxjZX0sY2UuZ2V0RGVmYXVsdHM9dCxjZS5kZWZhdWx0cz1lLmRlZmF1bHRzLGNlLnVzZT1mdW5jdGlvbiguLi5lKXtyZXR1cm4gYWUudXNlKC4uLmUpLGNlLmRlZmF1bHRzPWFlLmRlZmF1bHRzLG4oY2UuZGVmYXVsdHMpLGNlfSxjZS53YWxrVG9rZW5zPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIGFlLndhbGtUb2tlbnMoZSx0KX0sY2UucGFyc2VJbmxpbmU9YWUucGFyc2VJbmxpbmUsY2UuUGFyc2VyPWllLGNlLnBhcnNlcj1pZS5wYXJzZSxjZS5SZW5kZXJlcj1zZSxjZS5UZXh0UmVuZGVyZXI9cmUsY2UuTGV4ZXI9bmUsY2UubGV4ZXI9bmUubGV4LGNlLlRva2VuaXplcj10ZSxjZS5Ib29rcz1sZSxjZS5wYXJzZT1jZTtjb25zdCBoZT1jZS5vcHRpb25zLHBlPWNlLnNldE9wdGlvbnMsdWU9Y2UudXNlLGdlPWNlLndhbGtUb2tlbnMsa2U9Y2UucGFyc2VJbmxpbmUsZGU9Y2UsZmU9aWUucGFyc2UseGU9bmUubGV4O2UuSG9va3M9bGUsZS5MZXhlcj1uZSxlLk1hcmtlZD1vZSxlLlBhcnNlcj1pZSxlLlJlbmRlcmVyPXNlLGUuVGV4dFJlbmRlcmVyPXJlLGUuVG9rZW5pemVyPXRlLGUuZ2V0RGVmYXVsdHM9dCxlLmxleGVyPXhlLGUubWFya2VkPWNlLGUub3B0aW9ucz1oZSxlLnBhcnNlPWRlLGUucGFyc2VJbmxpbmU9a2UsZS5wYXJzZXI9ZmUsZS5zZXRPcHRpb25zPXBlLGUudXNlPXVlLGUud2Fsa1Rva2Vucz1nZX0pKTs="></script>
				<script>
const vscode = acquireVsCodeApi();

let sendBtn = document.querySelector('#send');
let chatInput = document.querySelector('#chat');
let responseDiv = document.querySelector('#response');
let infoDiv = document.querySelector('#info');

let canSendMessage = true;
let fullResponse = '';
let responseEl = document.createElement('p');

function escapeHTML(text) {
	return text.replace(/[&<>"']/g, function(match) {
		switch(match) {
			case "&": return "&amp;";
			case "<": return "&lt;";
			case ">": return "&gt;";
			case '"': return "&quot;";
			case "'": return "&#39;";
			default: return match;
		}
	});
}

function processMarkdownWithThink(inputMarkdown) {
    let openThinkTag = false; // Track if <think> is open
    let processedMarkdown = '';

    // Process line by line to track unclosed <think> tags
    inputMarkdown.split('\\n').forEach(line => {
        if (line.includes('<think>')) {
            openThinkTag = true;
            line = line.replace('<think>', '<div class="think">');
        }
        if (line.includes('</think>')) {
            openThinkTag = false;
            line = line.replace('</think>', '</div>');
        }
        processedMarkdown += line + '\\n';
    });

    // Auto-close unclosed <think> tag at the end
    if (openThinkTag) {
        processedMarkdown += '</div>\\n';
    }

    // Convert Markdown to HTML using marked
    return marked.parse(processedMarkdown);
}

sendBtn.addEventListener('click', () => {
	if (canSendMessage) {
		canSendMessage = false;
		let message = chatInput.value.trim();
		console.log(message);
		chatInput.value = '';

		let el = document.createElement('p');
		el.textContent = '>>> ' + message;
		if (message) {
			responseDiv.appendChild(el);
			responseDiv.appendChild(responseEl);
			vscode.postMessage({ command: 'chat', text: message });
			window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
		}
	}
})

window.addEventListener('message', event => {
	if (event.data.command === 'response') {
		fullResponse += event.data.text;

		responseEl.innerHTML = processMarkdownWithThink(fullResponse);
	}

	if(event.data.command === 'done') {
		canSendMessage = true;
		responseDiv.appendChild(document.createElement('hr'));
		responseEl = document.createElement('p');
		fullResponse = '';
	}
})



				</script>
			</body>
			</html>
		`

		let messages = [
			{ role: 'user', content: 'System: You are a helpful AI assistant. You always think before saying something, no matter what.' }
		]

		panel.webview.onDidReceiveMessage(async message => {
			if (message.command === "chat") {
				const prompt = message.text;
				messages.push({ role: 'user', content: 'User: ' + prompt });
				let response = '';

				try {
					const streamResponse = await ollama.chat({
						model: model.name,
						messages,
						stream: true
					});

					console.log(streamResponse);

					for await (const part of streamResponse) {
						response += part.message.content;
						console.log(part.message.content);
						panel.webview.postMessage({ command: 'response', text: part.message.content });
					}

					messages.push({ role: 'user', content: 'Assistant: ' + response });
					panel.webview.postMessage({ command: 'done' });
				} catch (error) {
					panel.webview.postMessage({ command: 'response', message: 'System: A fatal error has occured.' });
					messages.push({ role: 'user', content: 'System: A fatal error has occured.' });
					panel.webview.postMessage({ command: 'done' });
				}
			}
			if (message.command === "log") {
				console.log(message.text);
			}
		})
	});

	context.subscriptions.push(disposable);

	disposable = vscode.commands.registerCommand('deepchat.set8b', function () {
		vscode.window.showInformationMessage('Set model to deepseek-r1:8b');
		model.name = 'deepseek-r1:8b';
	})
	context.subscriptions.push(disposable);

	disposable = vscode.commands.registerCommand('deepchat.set32b', function () {
        vscode.window.showInformationMessage('Set model to deepseek-r1:32b');
        model.name = 'deepseek-r1:32b';
    })
	context.subscriptions.push(disposable);

	disposable = vscode.commands.registerCommand('deepchat.set1.5b', function () {
        vscode.window.showInformationMessage('Set model to deepseek-r1:1.5b');
        model.name = 'deepseek-r1:1.5b';
    })
	context.subscriptions.push(disposable);
/* 
	vscode.workspace.onDidChangeTextDocument(async (event) => {
        const editor = vscode.window.activeTextEditor;
        if (!editor || editor.document !== event.document) return;

		hideCompletion();

        // Trigger completion when user types
        if (event.contentChanges.length > 0) {
            showCompletion(model.name);
        }
    });

    disposable = vscode.commands.registerCommand('deepchat.triggerCompletion', () => {
		hideCompletion();
		showCompletion(model.name);
	});
	context.subscriptions.push(disposable);
	
	disposable = vscode.commands.registerCommand('deepchat.acceptCompletion', () => {
		typeInCompletion();
		hideCompletion();
	});
	context.subscriptions.push(disposable); */
}

// This method is called when your extension is deactivated
function deactivate() { }

module.exports = {
	activate,
	deactivate
}
